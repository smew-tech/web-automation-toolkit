<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMEW Automation Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .action-card {
            cursor: grab;
            position: relative;
        }

        .action-card:active {
            cursor: grabbing;
        }

        .action-card:hover::after {
            content: attr(data-tooltip-text);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgb(31 41 55);
            color: rgb(243 244 246);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
        }
        .dark .action-card:hover::after {
            background-color: rgb(51 65 85);
            color: rgb(248 250 252);
        }

        #canvas-container {
            position: relative;
            overflow: hidden;
            background-image:
                radial-gradient(circle, #e2e8f0 1px, transparent 1px),
                radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .dark #canvas-container {
            background-image:
                radial-gradient(circle, #374151 1px, transparent 1px),
                radial-gradient(circle, #374151 1px, transparent 1px);
        }

        #canvas-container.panning,
        #canvas-container.panning .workflow-node {
            cursor: grabbing;
        }

        #canvas-container.pannable,
        #canvas-container.pannable .workflow-node {
            cursor: grab;
        }

        #transform-container {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-origin: 0 0;
        }

        #connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
            overflow: visible;
        }

        .connector-group>* {
            pointer-events: all;
        }

        .connector-path {
            stroke-width: 1.5px;
            fill: none;
            stroke-dasharray: 3 4;
            cursor: pointer;
            transition: stroke-width 0.2s ease;
        }

        .connector-group:hover .connector-path {
            stroke-width: 2.5px;
        }

        .connector-hitbox {
            stroke: transparent;
            stroke-width: 20px;
            fill: none;
            cursor: pointer;
        }

        .connector-path-temp {
            stroke: #3b82f6;
            /* blue-500 */
            stroke-width: 2px;
            stroke-dasharray: 4 4;
            fill: none;
            pointer-events: none;
            transition: stroke 0.1s ease;
        }

        .connector-path-temp.valid-target {
            stroke: #22c55e;
        }

        /* green-500 */
        .connector-path-temp.invalid-target {
            stroke: #ef4444;
        }

        /* red-500 */

        .workflow-node {
            position: absolute;
            width: 220px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: move;
            transition: box-shadow 0.2s, border-color 0.2s;
        }

        .selected-node {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        /* Force header background and text colors - draw.io style */
        header {
            background-color: rgb(250 250 250) !important;
            color: rgb(51 51 51) !important;
            border-color: rgb(224 224 224) !important;
        }
        .dark header {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Force sidebar background colors - draw.io style */
        aside {
            background-color: rgb(250 250 250) !important;
            color: rgb(51 51 51) !important;
            border-color: rgb(224 224 224) !important;
        }
        .dark aside {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Force main section background colors - draw.io style */
        section {
            background-color: rgb(250 250 250) !important;
            color: rgb(51 51 51) !important;
            border-color: rgb(224 224 224) !important;
        }
        .dark section {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Force body background - draw.io style */
        body {
            background-color: rgb(245 245 245) !important;
        }
        .dark body {
            background-color: rgb(20 20 20) !important;
        }
        
        /* Canvas with warm undertones */
        #canvas-container {
            background-color: rgb(255 255 253) !important; /* Very subtle warm white */
        }
        .dark #canvas-container {
            background-color: rgb(25 25 25) !important;
        }
        
        /* Action cards with warm tones */
        .action-card > div {
            background-color: rgb(253 253 251) !important; /* Very light warm */
            color: rgb(45 45 45) !important;
            border-color: rgb(224 219 214) !important; /* Warm border */
        }
        .dark .action-card > div {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Fix action cards hover states */
        .action-card > div:hover {
            border-color: rgb(99 102 241) !important;
        }
        .dark .action-card > div:hover {
            border-color: rgb(129 140 248) !important;
        }
        
        /* Workflow nodes with warm tones */
        .workflow-node {
            background-color: rgb(255 255 253) !important; /* Subtle warm white */
            color: rgb(45 45 45) !important;
            border-color: rgb(224 219 214) !important; /* Warm border */
        }
        .dark .workflow-node {
            background-color: rgb(35 35 35) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(55 55 55) !important;
        }
        
        /* Fix text colors throughout website */
        body, h1, h2, h3, h4, h5, h6, p, span, div, label, summary {
            color: rgb(51 51 51) !important;
        }
        .dark body, .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6, 
        .dark p, .dark span, .dark div, .dark label, .dark summary {
            color: rgb(220 220 220) !important;
        }
        
        /* Fix input and button text colors */
        input, textarea, button {
            color: rgb(51 51 51) !important;
        }
        .dark input, .dark textarea, .dark button {
            color: rgb(220 220 220) !important;
        }
        
        /* Keep button background colors intact but fix text */
        button[class*="bg-"] {
            color: white !important;
        }
        
        /* Draw.io inspired warm color scheme */
        /* Warm off-white backgrounds instead of harsh white */
        body {
            background-color: rgb(251 251 249) !important; /* Very light warm beige */
        }
        .dark body {
            background-color: rgb(15 15 15) !important;
        }
        
        /* Soft cream colored panels */
        header {
            background-color: rgb(254 254 252) !important; /* Warm white */
            border-color: rgb(224 219 214) !important; /* Warm border */
        }
        .dark header {
            background-color: rgb(28 28 28) !important;
            border-color: rgb(48 48 48) !important;
        }
        
        aside {
            background-color: rgb(254 254 252) !important; /* Warm white */
            border-color: rgb(224 219 214) !important;
        }
        .dark aside {
            background-color: rgb(28 28 28) !important;
            border-color: rgb(48 48 48) !important;
        }
        
        section {
            background-color: rgb(254 254 252) !important; /* Warm white */
            border-color: rgb(224 219 214) !important;
        }
        .dark section {
            background-color: rgb(28 28 28) !important;
            border-color: rgb(48 48 48) !important;
        }
        
        /* Fix hover states to be theme aware */
        *[class*="hover:bg-slate-"], *[class*="hover:bg-gray-"] {
            transition: background-color 0.2s !important;
        }
        
        summary:hover, button:hover:not([class*="bg-"]) {
            background-color: rgb(243 244 246) !important;
        }
        .dark summary:hover, .dark button:hover:not([class*="bg-"]) {
            background-color: rgb(55 55 55) !important;
        }
        
        /* Remove annoying line under workflow-node header */
        .node-header {
            border-bottom: none !important;
        }
        
        /* Comprehensive theme overrides - fix everything stuck in dark mode */
        /* Force override all Tailwind dark: classes */
        .dark\:bg-gray-800, .dark\:bg-gray-700, .dark\:bg-gray-600, .dark\:bg-gray-900 {
            background-color: rgb(254 254 252) !important;
        }
        .dark .dark\:bg-gray-800, .dark .dark\:bg-gray-700, .dark .dark\:bg-gray-600, .dark .dark\:bg-gray-900 {
            background-color: rgb(28 28 28) !important;
        }
        
        /* Fix text colors that might be stuck */
        .dark\:text-gray-200, .dark\:text-gray-300, .dark\:text-gray-400, .dark\:text-gray-100 {
            color: rgb(51 51 51) !important;
        }
        .dark .dark\:text-gray-200, .dark .dark\:text-gray-300, .dark .dark\:text-gray-400, .dark .dark\:text-gray-100 {
            color: rgb(220 220 220) !important;
        }
        
        /* Fix border colors */
        .dark\:border-gray-700, .dark\:border-gray-600, .dark\:border-gray-500 {
            border-color: rgb(224 219 214) !important;
        }
        .dark .dark\:border-gray-700, .dark .dark\:border-gray-600, .dark .dark\:border-gray-500 {
            border-color: rgb(48 48 48) !important;
        }
        
        /* Override any remaining Tailwind classes that might be problematic */
        [class*="dark:"] {
            transition: all 0.2s ease !important;
        }
        
        /* Fix specific toggle buttons hover states */
        #language-toggle-button, #theme-toggle-button {
            color: rgb(75 75 75) !important;
        }
        .dark #language-toggle-button, .dark #theme-toggle-button {
            color: rgb(180 180 180) !important;
        }
        
        #language-toggle-button:hover, #theme-toggle-button:hover {
            background-color: rgb(248 246 242) !important; /* Warm hover */
            color: rgb(45 45 45) !important;
        }
        .dark #language-toggle-button:hover, .dark #theme-toggle-button:hover {
            background-color: rgb(45 45 45) !important;
            color: rgb(220 220 220) !important;
        }
        
        /* Fix theme toggle icons visibility */
        .fa-sun {
            display: block !important;
        }
        .dark .fa-sun {
            display: none !important;
        }
        
        .fa-moon {
            display: none !important;
        }
        .dark .fa-moon {
            display: block !important;
        }

        .node-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
        }

        .node-content {
            padding: 0.75rem;
            font-size: 0.875rem;
        }

        .node-port {
            position: absolute;
            width: 14px;
            height: 14px;
            background-color: white;
            border: 2px solid #94a3b8;
            border-radius: 50%;
            cursor: pointer;
            z-index: 15;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .workflow-node:hover .node-port,
        .workflow-node.selected-node .node-port,
        .workflow-node.show-ports .node-port {
            visibility: visible;
            opacity: 1;
        }

        .dark .node-port {
            background-color: #374151;
            border-color: #6b7280;
        }

        .node-port.output-port:hover {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        /* Blue for output */
        .dark .node-port.output-port:hover {
            background-color: #2563eb;
        }

        .node-port.input-port:hover {
            border-color: #16a34a;
            background-color: #dcfce7;
        }

        /* Green for input */
        .dark .node-port.input-port:hover {
            background-color: #166534;
        }

        .port-right {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port-bottom {
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .port-left {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port-top {
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .port-if-then {
            top: 33.33%;
            right: -8px;
            transform: translateY(-50%);
        }

        .port-if-else {
            top: 66.67%;
            right: -8px;
            transform: translateY(-50%);
        }

        .port-label {
            position: absolute;
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
            text-transform: uppercase;
        }

        .label-then {
            right: 12px;
            top: 33.33%;
            transform: translateY(-50%);
        }

        /* green-500 */
        .label-else {
            right: 12px;
            top: 66.67%;
            transform: translateY(-50%);
        }

        /* red-500 */

        .port-tooltip {
            position: absolute;
            background-color: rgb(31 41 55) !important;
            color: rgb(243 244 246) !important;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .dark .port-tooltip {
            background-color: rgb(51 65 85);
            color: rgb(248 250 252);
        }

        .selected-node .port-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Help button tooltips */
        .help-btn {
            position: relative;
        }

        .help-btn:hover::after {
            content: attr(title);
            position: absolute;
            top: 50%;
            left: -300px;
            transform: translateY(-50%);
            background: #f9fafb;
            color: #1f2937;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 12px;
            width: 280px;
            white-space: normal;
            word-wrap: break-word;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            line-height: 1.4;
        }

        .help-btn:hover::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -14px;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-left-color: #f9fafb;
            z-index: 9999;
        }

        .dark .help-btn:hover::after {
            background: #1f2937;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark .help-btn:hover::before {
            border-left-color: #1f2937;
        }

        .port-top+.port-tooltip {
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
        }

        .port-bottom+.port-tooltip {
            top: 105%;
            left: 50%;
            transform: translateX(-50%) translateY(6px);
        }

        .port-left+.port-tooltip {
            right: 102%;
            top: 50%;
            transform: translateY(-50%) translateX(-6px);
        }

        .port-right+.port-tooltip {
            left: 102%;
            top: 50%;
            transform: translateY(-50%) translateX(6px);
        }

        .port-if-then+.port-tooltip {
            left: 102%;
            top: 33.33%;
            transform: translateY(-50%) translateX(6px);
        }

        .port-if-else+.port-tooltip {
            left: 102%;
            top: 66.67%;
            transform: translateY(-50%) translateX(6px);
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] .details-marker {
            transform: rotate(90deg);
        }

        /* Áp dụng cho các trình duyệt WebKit (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Dark mode scrollbar for WebKit */
        .dark ::-webkit-scrollbar-track {
            background: rgb(55 65 81);
        }
        .dark ::-webkit-scrollbar-thumb {
            background: rgb(107 114 128);
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgb(156 163 175);
        }
        /* Áp dụng cho Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f1f5f9;
        }
        .dark * {
            scrollbar-color: rgb(107 114 128) rgb(55 65 81);
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-gray-200 h-screen flex flex-col overflow-hidden">

    <header class="bg-white dark:bg-gray-800 border-b border-slate-200 dark:border-gray-700 z-20 flex-shrink-0">
        <div class="px-4 py-2 flex justify-between items-center">
            <h1 class="text-lg font-bold text-slate-900 dark:text-gray-100"><i class="fas fa-sitemap text-blue-600"></i>
                SMEW Automation Builder</h1>
            <div class="flex items-center space-x-2">
                <button id="test-button"
                    class="bg-green-500 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-green-600 transition-colors active:scale-95 text-sm disabled:opacity-50 disabled:cursor-not-allowed"><i
                        class="fas fa-play mr-2"></i>Test</button>
                <button id="import-button"
                    class="bg-sky-500 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-sky-600 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-upload mr-2"></i>Import</button>
                <input type="file" id="import-file" class="hidden" accept=".json">
                <button id="export-button"
                    class="bg-slate-700 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-slate-800 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-download mr-2"></i>Export</button>
                <button id="guideline-button"
                    class="bg-purple-600 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-purple-700 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-book mr-2"></i>Guide</button>
                <button id="clear-button"
                    class="bg-red-500 text-white font-semibold px-2.5 py-1.5 rounded-md hover:bg-red-600 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-trash"></i></button>
                <button id="language-toggle-button"
                    class="text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-md p-1.5 transition-colors mr-2">
                    <span id="current-lang" class="font-semibold">EN</span>
                </button>
                <button id="theme-toggle-button"
                    class="text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-md p-1.5 transition-colors">
                    <i class="fas fa-sun block dark:hidden"></i>
                    <i class="fas fa-moon hidden dark:block"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 grid grid-cols-1 lg:grid-cols-12 gap-4" style="min-height: 0;">

        <aside
            class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg border border-slate-200 dark:border-gray-700 p-2 flex flex-col overflow-hidden">
            <div class="flex-grow min-h-0 overflow-y-auto pr-1">
                <details open class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Logic
                    </summary>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="if" data-tooltip-text="Điều Kiện">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-indigo-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-code-branch text-indigo-500 dark:text-indigo-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="advancedCondition" data-tooltip-text="Điều Kiện Nâng Cao">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-project-diagram text-blue-500 dark:text-blue-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="forEach"
                            data-tooltip-text="Vòng Lặp">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-sync-alt text-purple-500 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="setVariable"
                            data-tooltip-text="Gán Biến">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-pink-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-equals text-pink-500 dark:text-pink-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="stop" data-tooltip-text="Dừng">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-stop-circle text-red-500 dark:text-red-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="comment"
                            data-tooltip-text="Ghi Chú">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-comment-dots text-gray-500 dark:text-gray-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details open class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Điều Hướng
                    </summary>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="goto"
                            data-tooltip-text="Truy cập URL">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-sky-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-link text-sky-500 dark:text-sky-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="reload"
                            data-tooltip-text="Tải Lại Trang">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-redo text-green-500 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="goBack"
                            data-tooltip-text="Lùi Lại Trang">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-slate-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-arrow-left text-slate-500 dark:text-slate-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="goForward"
                            data-tooltip-text="Tới Trang Trước">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-slate-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-arrow-right text-slate-500 dark:text-slate-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details open class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Tương Tác
                    </summary>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="click" data-tooltip-text="Nhấp">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-amber-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-hand-pointer text-amber-500 dark:text-amber-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="fill" data-tooltip-text="Điền">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-violet-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-keyboard text-violet-500 dark:text-violet-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="clearInput"
                            data-tooltip-text="Xóa Ô Nhập Liệu">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-eraser text-red-500 dark:text-red-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="setCheckboxState"
                            data-tooltip-text="Trạng thái Checkbox">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-check-square text-blue-500 dark:text-blue-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="selectOption"
                            data-tooltip-text="Chọn Dropdown">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-orange-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-list-ul text-orange-500 dark:text-orange-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="hover"
                            data-tooltip-text="Di chuột qua">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-cyan-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-mouse-pointer text-cyan-500 dark:text-cyan-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="press"
                            data-tooltip-text="Nhấn Phím">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-teal-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-arrow-turn-down text-teal-500 dark:text-teal-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="uploadFile"
                            data-tooltip-text="Tải Lên Tệp">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-fuchsia-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-file-upload text-fuchsia-500 dark:text-fuchsia-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Chờ Đợi
                    </summary>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="waitTimeout"
                            data-tooltip-text="Chờ Thời Gian">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-clock text-gray-500 dark:text-gray-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="waitElement"
                            data-tooltip-text="Chờ Phần Tử">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-binoculars text-blue-500 dark:text-blue-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Trích Xuất
                    </summary>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="getText"
                            data-tooltip-text="Lấy Văn bản">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-rose-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-quote-left text-rose-500 dark:text-rose-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="getAttribute"
                            data-tooltip-text="Lấy Thuộc tính">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-lime-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-at text-lime-500 dark:text-lime-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="getInputValue"
                            data-tooltip-text="Lấy Giá trị Input">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-i-cursor text-purple-500 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="screenshot"
                            data-tooltip-text="Chụp Ảnh">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-camera text-gray-500 dark:text-gray-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="sessionCache"
                            data-tooltip-text="Session Cache">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-orange-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-memory text-orange-500 dark:text-orange-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="customApiRequest"
                            data-tooltip-text="Custom API Request">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-paper-plane text-blue-500 dark:text-blue-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="responseProcessor"
                            data-tooltip-text="Response Processor">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-cogs text-green-500 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="storageSettings"
                            data-tooltip-text="Storage Settings">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-hdd text-purple-500 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Node Validation Header -->
                    <div class="px-1.5 py-1 text-xs font-normal text-slate-600 dark:text-gray-400 uppercase tracking-wide border-b border-slate-300 dark:border-gray-600" id="node-validation-header">
                        Kiểm Tra Node ID
                    </div>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="checkNodeExists"
                            data-tooltip-text="Kiểm Tra Node Tồn Tại">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-cyan-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-search text-cyan-500 dark:text-cyan-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkNodeValue"
                            data-tooltip-text="Kiểm Tra Giá Trị Node">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-teal-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-check-circle text-teal-500 dark:text-teal-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="getNodeList"
                            data-tooltip-text="Lấy Danh Sách Node">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-indigo-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-list text-indigo-500 dark:text-indigo-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="validateNodeData"
                            data-tooltip-text="Validate Dữ Liệu Node">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-emerald-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-shield-alt text-emerald-500 dark:text-emerald-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Kiểm Tra
                    </summary>
                    
                    <!-- Basic Assertions Header -->
                    <div class="px-1.5 py-1 text-xs font-normal text-slate-600 dark:text-gray-400 uppercase tracking-wide border-b border-slate-300 dark:border-gray-600" id="basic-assertions-header">
                        Kiểm Tra Cơ Bản
                    </div>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="assertVisible"
                            data-tooltip-text="Kiểm tra Hiển thị">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-eye text-green-500 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertText"
                            data-tooltip-text="Kiểm tra Văn bản">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-yellow-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-check-double text-yellow-500 dark:text-yellow-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertURL"
                            data-tooltip-text="Kiểm tra URL">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-link text-blue-500 dark:text-blue-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertTitle"
                            data-tooltip-text="Kiểm tra Tiêu đề">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-heading text-purple-500 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertAttribute"
                            data-tooltip-text="Kiểm tra Thuộc tính">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-orange-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-tags text-orange-500 dark:text-orange-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertElementCount"
                            data-tooltip-text="Kiểm tra Số lượng Phần tử">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-indigo-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-list-ol text-indigo-500 dark:text-indigo-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertNotVisible"
                            data-tooltip-text="Kiểm tra Không hiển thị">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-eye-slash text-red-500 dark:text-red-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertEnabled"
                            data-tooltip-text="Kiểm tra Kích hoạt">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-teal-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-toggle-on text-teal-500 dark:text-teal-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertDisabled"
                            data-tooltip-text="Kiểm tra Vô hiệu hóa">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-toggle-off text-gray-500 dark:text-gray-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertChecked"
                            data-tooltip-text="Kiểm tra Đã chọn">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-emerald-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-check-square text-emerald-500 dark:text-emerald-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertUnchecked"
                            data-tooltip-text="Kiểm tra Chưa chọn">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-pink-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-square text-pink-500 dark:text-pink-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertContainsText"
                            data-tooltip-text="Kiểm tra Chứa văn bản">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-cyan-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-search text-cyan-500 dark:text-cyan-400 text-lg"></i>
                            </div>
                        </div>
                        </div>
                    
                    <!-- Element States Header -->
                    <div class="px-1.5 py-1 text-xs font-normal text-slate-600 dark:text-gray-400 uppercase tracking-wide border-b border-slate-300 dark:border-gray-600" id="element-states-header">
                        Trạng Thái Element
                    </div>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="assertCSSProperty"
                            data-tooltip-text="Kiểm tra Thuộc tính CSS">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-violet-400 aspect-square flex items-center justify-center">
                                <i class="fab fa-css3-alt text-violet-500 dark:text-violet-400 text-lg"></i>
                            </div>
                        </div>
                        </div>
                    
                    <!-- Page Quality Header -->
                    <div class="px-1.5 py-1 text-xs font-normal text-slate-600 dark:text-gray-400 uppercase tracking-wide border-b border-slate-300 dark:border-gray-600" id="page-quality-header">
                        Chất Lượng Trang
                    </div>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="validateForm"
                            data-tooltip-text="Kiểm tra Form">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-amber-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-clipboard-check text-amber-500 dark:text-amber-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkBrokenLinks"
                            data-tooltip-text="Kiểm tra Liên kết lỗi">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-rose-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-unlink text-rose-500 dark:text-rose-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkImageLoading"
                            data-tooltip-text="Kiểm tra Tải ảnh">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-lime-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-image text-lime-500 dark:text-lime-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkPageSpeed"
                            data-tooltip-text="Kiểm tra Tốc độ Trang">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-sky-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-tachometer-alt text-sky-500 dark:text-sky-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkResponsive"
                            data-tooltip-text="Kiểm tra Responsive">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-slate-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-slate-500 dark:text-slate-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkAccessibility"
                            data-tooltip-text="Kiểm tra Khả năng tiếp cận">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-universal-access text-green-500 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkSEO"
                            data-tooltip-text="Kiểm tra SEO">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-yellow-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-search-plus text-yellow-500 dark:text-yellow-400 text-lg"></i>
                            </div>
                        </div>
                        </div>
                    
                    <!-- Advanced Testing Header -->
                    <div class="px-1.5 py-1 text-xs font-normal text-slate-600 dark:text-gray-400 uppercase tracking-wide border-b border-slate-300 dark:border-gray-600" id="advanced-testing-header">
                        Kiểm Tra Nâng Cao
                    </div>
                    <div class="grid grid-cols-4 gap-1 p-2">
                        <div class="action-card" draggable="true" data-action-type="interceptNetwork"
                            data-tooltip-text="Chặn Mạng">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-ban text-red-500 dark:text-red-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="mockAPI"
                            data-tooltip-text="Mock API">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-cloud text-purple-500 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="setCookie"
                            data-tooltip-text="Đặt Cookie">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-orange-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-cookie-bite text-orange-500 dark:text-orange-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkConsoleErrors"
                            data-tooltip-text="Kiểm tra Lỗi Console">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkMemoryUsage"
                            data-tooltip-text="Kiểm tra Sử dụng Bộ nhớ">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-memory text-blue-500 dark:text-blue-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkLocalStorage"
                            data-tooltip-text="Kiểm tra Local Storage">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-teal-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-database text-teal-500 dark:text-teal-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="checkSessionStorage"
                            data-tooltip-text="Kiểm tra Session Storage">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-indigo-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-archive text-indigo-500 dark:text-indigo-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="testCrossBrowser"
                            data-tooltip-text="Kiểm tra Cross Browser">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fab fa-firefox-browser text-green-500 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="simulateNetworkCondition"
                            data-tooltip-text="Mô phỏng Điều kiện Mạng">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-1.5 rounded-md border border-slate-200 dark:border-gray-600 hover:border-yellow-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-wifi text-yellow-500 dark:text-yellow-400 text-lg"></i>
                            </div>
                        </div>
                    
                </details>
            </div>
        </aside>

        <section
            class="lg:col-span-7 bg-white dark:bg-gray-800 rounded-lg border border-slate-200 dark:border-gray-700 flex flex-col p-0">
            <div id="canvas-container" class="flex-grow rounded-b-lg bg-slate-50 dark:bg-gray-900/50">
                <div id="transform-container">
                    <div id="node-container"></div>
                    <svg id="connection-svg">
                        <defs>
                            <marker id="end-circle" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-green-500" />
                            </marker>
                            <marker id="end-circle-temp" markerWidth="12" markerHeight="12" refX="6" refY="6"
                                orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-blue-600" />
                            </marker>
                            <marker id="end-circle-valid" markerWidth="12" markerHeight="12" refX="6" refY="6"
                                orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-green-500" />
                            </marker>
                            <marker id="end-circle-invalid" markerWidth="12" markerHeight="12" refX="6" refY="6"
                                orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-red-500" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </section>

        <aside id="right-sidebar"
            class="lg:col-span-3 bg-white dark:bg-gray-800 rounded-lg border border-slate-200 dark:border-gray-700 p-4 flex flex-col">
            <div id="properties-panel-container" class="flex flex-col h-full">
                <h2
                    class="text-lg font-semibold mb-4 pb-2 border-b border-slate-200 dark:border-gray-700 text-slate-900 dark:text-gray-100">
                    <i class="fas fa-sliders-h mr-2 text-slate-500 dark:text-gray-400"></i>Thuộc tính
                </h2>
                <div id="properties-panel" class="flex-grow overflow-y-auto">
                    <p class="text-slate-500 dark:text-gray-400 text-center mt-8">Chọn một khối để xem thuộc tính.</p>
                </div>
            </div>
        </aside>
    </main>


    <script>

        const translations = {
            en: {
                title: "SMEW Automation Builder",
                test: "Test",
                import: "Import",
                export: "Export",
                guide: "Guide",
                logic: "Logic",
                navigation: "Navigation",
                interaction: "Interaction",
                wait: "Wait",
                extract: "Extract",
                verify: "Verify",
                basicAssertions: "Basic Assertions", 
                elementStates: "Element States",
                pageQuality: "Page Quality",
                advancedTesting: "Advanced Testing",
                nodeValidation: "Node Validation",
                properties: "Properties",
                selectBlockToView: "Select a block to view properties.",

                condition: "Condition",
                advancedCondition: "Advanced Condition",
                loop: "Loop",
                setVariable: "Set Variable",
                stop: "Stop",
                comment: "Comment",
                gotoURL: "Go to URL",
                reload: "Reload Page",
                goBack: "Go Back",
                goForward: "Go Forward",
                click: "Click",
                fill: "Fill",
                clearInput: "Clear Input",
                checkboxState: "Checkbox State",
                selectOption: "Select Dropdown",
                hover: "Hover",
                keyPress: "Key Press",
                uploadFile: "Upload File",
                waitTime: "Wait Time",
                waitElement: "Wait Element",
                getText: "Get Text",
                getAttribute: "Get Attribute",
                getInputValue: "Get Input Value",
                screenshot: "Screenshot",
                sessionCache: "Session Cache",
                customApiRequest: "Custom API Request",
                responseProcessor: "Response Processor",
                storageSettings: "Storage Settings",
                checkNodeExists: "Check Node Exists",
                checkNodeValue: "Check Node Value",
                getNodeList: "Get Node List",
                validateNodeData: "Validate Node Data",
                assertVisible: "Assert Visible",
                assertText: "Assert Text",
                assertURL: "Assert URL",
                assertTitle: "Assert Title",
                assertAttribute: "Assert Attribute",
                assertElementCount: "Assert Element Count",
                assertNotVisible: "Assert Not Visible",
                assertEnabled: "Assert Enabled",
                assertDisabled: "Assert Disabled",
                assertChecked: "Assert Checked",
                assertUnchecked: "Assert Unchecked",
                assertContainsText: "Assert Contains Text",
                assertCSSProperty: "Assert CSS Property",
                validateForm: "Validate Form",
                checkBrokenLinks: "Check Broken Links",
                checkImageLoading: "Check Image Loading",
                checkPageSpeed: "Check Page Speed",
                checkResponsive: "Check Responsive",
                checkAccessibility: "Check Accessibility",
                checkSEO: "Check SEO",
                interceptNetwork: "Intercept Network",
                mockAPI: "Mock API",
                setCookie: "Set Cookie",
                checkConsoleErrors: "Check Console Errors",
                checkMemoryUsage: "Check Memory Usage",
                checkLocalStorage: "Check Local Storage",
                checkSessionStorage: "Check Session Storage",
                testCrossBrowser: "Test Cross Browser",
                simulateNetworkCondition: "Simulate Network Condition",

                start: "Start",

                input: "Input",
                output: "Output",
                then: "Then",
                else: "Else",
                next: "Next",
                loopBody: "Loop Body"
            },
            vi: {
                title: "SMEW Automation Builder",
                test: "Test",
                import: "Import",
                export: "Export",
                guide: "Hướng dẫn",
                logic: "Logic",
                navigation: "Điều Hướng",
                interaction: "Tương Tác",
                wait: "Chờ Đợi",
                extract: "Trích Xuất",
                verify: "Kiểm Tra",
                basicAssertions: "Kiểm Tra Cơ Bản",
                elementStates: "Trạng Thái Element", 
                pageQuality: "Chất Lượng Trang",
                advancedTesting: "Kiểm Tra Nâng Cao",
                nodeValidation: "Kiểm Tra Node ID",
                properties: "Thuộc tính",
                selectBlockToView: "Chọn một khối để xem thuộc tính.",

                condition: "Điều Kiện",
                advancedCondition: "Điều Kiện Nâng Cao",
                loop: "Vòng Lặp",
                setVariable: "Gán Biến",
                stop: "Dừng",
                comment: "Ghi Chú",
                gotoURL: "Truy cập URL",
                reload: "Tải Lại Trang",
                goBack: "Lùi Lại Trang",
                goForward: "Tới Trang Trước",
                click: "Nhấp",
                fill: "Điền",
                clearInput: "Xóa Ô Nhập Liệu",
                checkboxState: "Trạng thái Checkbox",
                selectOption: "Chọn Dropdown",
                hover: "Di chuột qua",
                keyPress: "Nhấn Phím",
                uploadFile: "Tải Lên Tệp",
                waitTime: "Chờ Thời Gian",
                waitElement: "Chờ Phần Tử",
                getText: "Lấy Văn bản",
                getAttribute: "Lấy Thuộc tính",
                getInputValue: "Lấy Giá trị Input",
                screenshot: "Chụp Ảnh",
                sessionCache: "Session Cache",
                customApiRequest: "Custom API Request",
                responseProcessor: "Xử Lý Response",
                storageSettings: "Cài Đặt Lưu Trữ",
                checkNodeExists: "Kiểm Tra Node Tồn Tại",
                checkNodeValue: "Kiểm Tra Giá Trị Node",
                getNodeList: "Lấy Danh Sách Node",
                validateNodeData: "Validate Dữ Liệu Node",
                assertVisible: "Kiểm tra Hiển thị",
                assertText: "Kiểm tra Văn bản",
                assertURL: "Kiểm tra URL",
                assertTitle: "Kiểm tra Tiêu đề",
                assertAttribute: "Kiểm tra Thuộc tính",
                assertElementCount: "Kiểm tra Số lượng Phần tử",
                assertNotVisible: "Kiểm tra Không hiển thị",
                assertEnabled: "Kiểm tra Kích hoạt",
                assertDisabled: "Kiểm tra Vô hiệu hóa",
                assertChecked: "Kiểm tra Đã chọn",
                assertUnchecked: "Kiểm tra Chưa chọn",
                assertContainsText: "Kiểm tra Chứa văn bản",
                assertCSSProperty: "Kiểm tra Thuộc tính CSS",
                validateForm: "Kiểm tra Form",
                checkBrokenLinks: "Kiểm tra Liên kết lỗi",
                checkImageLoading: "Kiểm tra Tải ảnh",
                checkPageSpeed: "Kiểm tra Tốc độ Trang",
                checkResponsive: "Kiểm tra Responsive",
                checkAccessibility: "Kiểm tra Khả năng tiếp cận",
                checkSEO: "Kiểm tra SEO",
                interceptNetwork: "Chặn Mạng",
                mockAPI: "Mock API",
                setCookie: "Đặt Cookie",
                checkConsoleErrors: "Kiểm tra Lỗi Console",
                checkMemoryUsage: "Kiểm tra Sử dụng Bộ nhớ",
                checkLocalStorage: "Kiểm tra Local Storage",
                checkSessionStorage: "Kiểm tra Session Storage",
                testCrossBrowser: "Kiểm tra Cross Browser",
                simulateNetworkCondition: "Mô phỏng Điều kiện Mạng",

                start: "Bắt đầu",

                input: "Đầu vào",
                output: "Đầu ra",
                then: "Then",
                else: "Else",
                next: "Tiếp theo",
                loopBody: "Vòng lặp"
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en';

        function updateLanguage() {
            const lang = translations[currentLanguage];
            document.getElementById('current-lang').textContent = currentLanguage.toUpperCase();
            document.documentElement.lang = currentLanguage;


            document.querySelector('h1').innerHTML = `<i class="fas fa-sitemap text-blue-600"></i> ${lang.title}`;


            document.getElementById('test-button').innerHTML = `<i class="fas fa-play mr-2"></i>${lang.test}`;
            document.getElementById('import-button').innerHTML = `<i class="fas fa-upload mr-2"></i>${lang.import}`;
            document.getElementById('guideline-button').innerHTML = `<i class="fas fa-book mr-2"></i>${lang.guide}`;
            
            // Update verify headers
            document.getElementById('basic-assertions-header').textContent = lang.basicAssertions;
            document.getElementById('element-states-header').textContent = lang.elementStates;
            document.getElementById('page-quality-header').textContent = lang.pageQuality;
            document.getElementById('advanced-testing-header').textContent = lang.advancedTesting;
            document.getElementById('node-validation-header').textContent = lang.nodeValidation;
            document.getElementById('export-button').innerHTML = `<i class="fas fa-download mr-2"></i>${lang.export}`;


            const tooltipMapping = {
                'if': lang.condition,
                'advancedCondition': lang.advancedCondition,
                'forEach': lang.loop,
                'setVariable': lang.setVariable,
                'stop': lang.stop,
                'comment': lang.comment,
                'goto': lang.gotoURL,
                'reload': lang.reload,
                'goBack': lang.goBack,
                'goForward': lang.goForward,
                'click': lang.click,
                'fill': lang.fill,
                'clearInput': lang.clearInput,
                'setCheckboxState': lang.checkboxState,
                'selectOption': lang.selectOption,
                'hover': lang.hover,
                'press': lang.keyPress,
                'uploadFile': lang.uploadFile,
                'waitTimeout': lang.waitTime,
                'waitElement': lang.waitElement,
                'getText': lang.getText,
                'getAttribute': lang.getAttribute,
                'getInputValue': lang.getInputValue,
                'screenshot': lang.screenshot,
                'sessionCache': lang.sessionCache,
                'customApiRequest': lang.customApiRequest,
                'responseProcessor': lang.responseProcessor,
                'storageSettings': lang.storageSettings,
                'checkNodeExists': lang.checkNodeExists,
                'checkNodeValue': lang.checkNodeValue,
                'getNodeList': lang.getNodeList,
                'validateNodeData': lang.validateNodeData,
                'assertVisible': lang.assertVisible,
                'assertText': lang.assertText,
                'assertURL': lang.assertURL,
                'assertTitle': lang.assertTitle,
                'assertAttribute': lang.assertAttribute,
                'assertElementCount': lang.assertElementCount,
                'assertNotVisible': lang.assertNotVisible,
                'assertEnabled': lang.assertEnabled,
                'assertDisabled': lang.assertDisabled,
                'assertChecked': lang.assertChecked,
                'assertUnchecked': lang.assertUnchecked,
                'assertContainsText': lang.assertContainsText,
                'assertCSSProperty': lang.assertCSSProperty,
                'validateForm': lang.validateForm,
                'checkBrokenLinks': lang.checkBrokenLinks,
                'checkImageLoading': lang.checkImageLoading,
                'checkPageSpeed': lang.checkPageSpeed,
                'checkResponsive': lang.checkResponsive,
                'checkAccessibility': lang.checkAccessibility,
                'checkSEO': lang.checkSEO,
                'interceptNetwork': lang.interceptNetwork,
                'mockAPI': lang.mockAPI,
                'setCookie': lang.setCookie,
                'checkConsoleErrors': lang.checkConsoleErrors,
                'checkMemoryUsage': lang.checkMemoryUsage,
                'checkLocalStorage': lang.checkLocalStorage,
                'checkSessionStorage': lang.checkSessionStorage,
                'testCrossBrowser': lang.testCrossBrowser,
                'simulateNetworkCondition': lang.simulateNetworkCondition
            };


            Object.keys(tooltipMapping).forEach(actionType => {
                document.querySelectorAll(`[data-action-type="${actionType}"]`).forEach(card => {
                    card.setAttribute('data-tooltip-text', tooltipMapping[actionType]);
                });
            });


            document.querySelectorAll('details summary').forEach(summary => {
                const icon = summary.querySelector('i');
                const text = summary.textContent.trim();
                if (text.includes('Logic')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.logic}`;
                } else if (text.includes('Điều Hướng') || text.includes('Navigation')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.navigation}`;
                } else if (text.includes('Tương Tác') || text.includes('Interaction')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.interaction}`;
                } else if (text.includes('Chờ Đợi') || text.includes('Wait')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.wait}`;
                } else if (text.includes('Trích Xuất') || text.includes('Extract')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.extract}`;
                } else if (text.includes('Kiểm Tra') || text.includes('Verify')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.verify}`;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const languageToggleButton = document.getElementById('language-toggle-button');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const htmlEl = document.documentElement;

            const applyTheme = (isDark) => {
                htmlEl.classList.toggle('dark', isDark);
                localStorage.theme = isDark ? 'dark' : 'light';
            };

            languageToggleButton.addEventListener('click', () => {
                currentLanguage = currentLanguage === 'en' ? 'vi' : 'en';
                localStorage.setItem('language', currentLanguage);
                updateLanguage();
                renderAll();
            });

            themeToggleButton.addEventListener('click', () => applyTheme(!htmlEl.classList.contains('dark')));
            applyTheme(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));


            updateLanguage();

            let nodes = [];
            let connections = [];
            let selectedNodeId = null;
            let dragInfo = {};
            let tempConnection = { active: false, startNode: null, startPort: null, path: null };
            let scale = 1, panX = 0, panY = 0, isPanning = false, isSpacePressed = false, panStart = { x: 0, y: 0 };
            let isTesting = false;
            let isTestStopped = false;
            
            // Node ID generation system
            let nodeCounters = {};
            
            function generateNodeId(type) {
                // Initialize counter if not exists
                if (!nodeCounters[type]) {
                    nodeCounters[type] = 0;
                }
                
                // Increment counter
                nodeCounters[type]++;
                
                // Generate readable ID based on type
                const typeMap = {
                    'start': 'start',
                    'stop': 'stop',
                    'goto': 'goToUrl',
                    'fill': 'inputText',
                    'click': 'clickElement',
                    'getText': 'getText',
                    'getAttribute': 'getAttribute',
                    'waitElement': 'waitElement',
                    'sessionCache': 'sessionCache',
                    'customApiRequest': 'apiRequest',
                    'responseProcessor': 'processResponse',
                    'storageSettings': 'storageSettings',
                    'checkNodeExists': 'checkNodeExists',
                    'checkNodeValue': 'checkNodeValue',
                    'getNodeList': 'getNodeList',
                    'validateNodeData': 'validateNodeData',
                    'if': 'condition',
                    'advancedCondition': 'advancedCondition',
                    'forEach': 'loop',
                    'comment': 'comment'
                };
                
                const baseName = typeMap[type] || type;
                return `${baseName}_${nodeCounters[type]}`;
            }
            
            function resetNodeCounters() {
                nodeCounters = {};
            }

            const canvasContainer = document.getElementById('canvas-container');
            const transformContainer = document.getElementById('transform-container');
            const nodeContainer = document.getElementById('node-container');
            const svg = document.getElementById('connection-svg');
            const propertiesPanelContainer = document.getElementById('properties-panel-container');
            const clearButton = document.getElementById('clear-button');
            const exportButton = document.getElementById('export-button');
            const importButton = document.getElementById('import-button');
            const importFileInput = document.getElementById('import-file');
            const testButton = document.getElementById('test-button');



            const getActionConfig = () => {
                const lang = translations[currentLanguage];
                return {
                    'start': { icon: 'fa-play-circle text-green-500 dark:text-green-400', name: lang.start, params: [] },
                    'if': { icon: 'fa-code-branch text-indigo-500 dark:text-indigo-400', name: lang.condition, params: [
                        { id: 'leftOperand', label: currentLanguage === 'vi' ? 'Giá trị bên trái' : 'Left operand', type: 'text', placeholder: '{{sessionCache_1.phone}}' },
                        { id: 'operator', label: currentLanguage === 'vi' ? 'Toán tử so sánh' : 'Comparison operator', type: 'select', options: [
                            { value: 'equals', text: 'Equals (=)' },
                            { value: 'notEquals', text: 'Not Equals (!=)' },
                            { value: 'greater', text: 'Greater (>)' },
                            { value: 'greaterEqual', text: 'Greater Equal (>=)' },
                            { value: 'less', text: 'Less (<)' },
                            { value: 'lessEqual', text: 'Less Equal (<=)' },
                            { value: 'contains', text: 'Contains' },
                            { value: 'notContains', text: 'Not Contains' },
                            { value: 'startsWith', text: 'Starts With' },
                            { value: 'endsWith', text: 'Ends With' },
                            { value: 'isEmpty', text: 'Is Empty' },
                            { value: 'isNotEmpty', text: 'Is Not Empty' },
                            { value: 'matches', text: 'Matches Regex' }
                        ], value: 'equals' },
                        { id: 'rightOperand', label: currentLanguage === 'vi' ? 'Giá trị bên phải' : 'Right operand', type: 'text', placeholder: '{{apiRequest_1.status}} or "success"' },
                        { id: 'logicalOperator', label: currentLanguage === 'vi' ? 'Toán tử logic (tùy chọn)' : 'Logical operator (optional)', type: 'select', options: [
                            { value: 'none', text: currentLanguage === 'vi' ? 'Không có' : 'None' },
                            { value: 'and', text: 'AND' },
                            { value: 'or', text: 'OR' }
                        ], value: 'none' },
                        { id: 'secondCondition', label: currentLanguage === 'vi' ? 'Điều kiện thứ 2 (tùy chọn)' : 'Second condition (optional)', type: 'textarea', placeholder: '{{processResponse_1.user_id}} > 0\n{{sessionCache_1.email}} contains "@"' },
                        { id: 'description', label: currentLanguage === 'vi' ? 'Mô tả điều kiện' : 'Condition description', type: 'text', placeholder: currentLanguage === 'vi' ? 'Kiểm tra đăng nhập thành công' : 'Check login success' }
                    ] },
                    'advancedCondition': { icon: 'fa-project-diagram text-blue-500 dark:text-blue-400', name: lang.advancedCondition, params: [
                        { id: 'conditions', label: currentLanguage === 'vi' ? 'Danh sách điều kiện' : 'Conditions list', type: 'textarea', placeholder: '{{sessionCache_1.phone}} equals "0123456789"\n{{apiRequest_1.status}} equals "success"\n{{processResponse_1.user_id}} > 0\n{{sessionCache_1.email}} contains "@gmail.com"' },
                        { id: 'logicExpression', label: currentLanguage === 'vi' ? 'Biểu thức logic' : 'Logic expression', type: 'text', placeholder: '(1 AND 2) OR (3 AND 4)' },
                        { id: 'evaluationMode', label: currentLanguage === 'vi' ? 'Chế độ đánh giá' : 'Evaluation mode', type: 'select', options: [
                            { value: 'all', text: currentLanguage === 'vi' ? 'Tất cả phải đúng (AND)' : 'All must be true (AND)' },
                            { value: 'any', text: currentLanguage === 'vi' ? 'Chỉ cần 1 đúng (OR)' : 'Any must be true (OR)' },
                            { value: 'custom', text: currentLanguage === 'vi' ? 'Biểu thức tùy chỉnh' : 'Custom expression' }
                        ], value: 'all' },
                        { id: 'onTrueAction', label: currentLanguage === 'vi' ? 'Khi điều kiện đúng' : 'When condition is true', type: 'select', options: [
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục THEN' : 'Continue to THEN' },
                            { value: 'jump', text: currentLanguage === 'vi' ? 'Nhảy đến node' : 'Jump to node' },
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' }
                        ], value: 'continue' },
                        { id: 'onFalseAction', label: currentLanguage === 'vi' ? 'Khi điều kiện sai' : 'When condition is false', type: 'select', options: [
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục ELSE' : 'Continue to ELSE' },
                            { value: 'jump', text: currentLanguage === 'vi' ? 'Nhảy đến node' : 'Jump to node' },
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' }
                        ], value: 'continue' },
                        { id: 'description', label: currentLanguage === 'vi' ? 'Mô tả logic' : 'Logic description', type: 'text', placeholder: currentLanguage === 'vi' ? 'Kiểm tra đăng nhập và validate user' : 'Check login and validate user' }
                    ] },
                    'forEach': { icon: 'fa-sync-alt text-purple-500 dark:text-purple-400', name: lang.loop, params: [{ id: 'list', label: currentLanguage === 'vi' ? 'Mảng hoặc Số Lần' : 'Array or Count', type: 'text', placeholder: 'myArray | 5' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Biến phần tử' : 'Item Variable', type: 'text', placeholder: 'item' }] },
                    'setVariable': { icon: 'fa-equals text-pink-500 dark:text-pink-400', name: lang.setVariable, params: [{ id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'myVar' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: '"Hello World!"' }] },
                    'stop': { icon: 'fa-stop-circle text-red-500 dark:text-red-400', name: lang.stop, params: [] },
                    'comment': { icon: 'fa-comment-dots text-gray-500 dark:text-gray-400', name: lang.comment, params: [{ id: 'text', label: currentLanguage === 'vi' ? 'Nội dung' : 'Content', type: 'text', placeholder: currentLanguage === 'vi' ? 'Ghi chú ở đây...' : 'Comment here...' }] },
                    'goto': { icon: 'fa-link text-sky-500 dark:text-sky-400', name: lang.gotoURL, params: [{ id: 'url', label: 'URL', type: 'text', placeholder: 'https://example.com' }] },
                    'reload': { icon: 'fa-redo text-green-500 dark:text-green-400', name: lang.reload, params: [] },
                    'goBack': { icon: 'fa-arrow-left text-slate-500 dark:text-slate-400', name: lang.goBack, params: [] },
                    'goForward': { icon: 'fa-arrow-right text-slate-500 dark:text-slate-400', name: lang.goForward, params: [] },
                    'click': { icon: 'fa-hand-pointer text-amber-500 dark:text-amber-400', name: lang.click, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.btn-primary' }, { id: 'type', label: currentLanguage === 'vi' ? 'Loại Click' : 'Click Type', type: 'select', options: [{ value: 'left', text: currentLanguage === 'vi' ? 'Trái' : 'Left' }, { value: 'right', text: currentLanguage === 'vi' ? 'Phải' : 'Right' }, { value: 'double', text: 'Double Click' }] }] },
                    'fill': { icon: 'fa-keyboard text-violet-500 dark:text-violet-400', name: lang.fill, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#username' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: currentLanguage === 'vi' ? 'Nhập giá trị...' : 'Enter value...' }] },
                    'clearInput': { icon: 'fa-eraser text-red-500 dark:text-red-400', name: lang.clearInput, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#search' }] },
                    'setCheckboxState': { icon: 'fa-check-square text-blue-500 dark:text-blue-400', name: lang.checkboxState, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#terms' }, { id: 'state', label: currentLanguage === 'vi' ? 'Trạng thái' : 'State', type: 'select', options: [{ value: 'check', text: 'Check' }, { value: 'uncheck', text: 'Uncheck' }] }] },
                    'selectOption': { icon: 'fa-list-ul text-orange-500 dark:text-orange-400', name: lang.selectOption, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#country' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: 'Vietnam' }] },
                    'hover': { icon: 'fa-mouse-pointer text-cyan-500 dark:text-cyan-400', name: lang.hover, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.menu-item' }] },
                    'press': { icon: 'fa-arrow-down-to-bracket text-teal-500 dark:text-teal-400', name: lang.keyPress, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'input[name="q"]' }, { id: 'key', label: currentLanguage === 'vi' ? 'Phím' : 'Key', type: 'text', placeholder: 'Enter' }] },
                    'uploadFile': { icon: 'fa-file-upload text-fuchsia-500 dark:text-fuchsia-400', name: lang.uploadFile, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'input[type="file"]' }, { id: 'filePath', label: currentLanguage === 'vi' ? 'Đường dẫn tệp' : 'File Path', type: 'text', placeholder: 'C:\\Users\\...\\file.txt' }] },
                    'waitTimeout': { icon: 'fa-clock text-gray-500 dark:text-gray-400', name: lang.waitTime, params: [{ id: 'timeout', label: currentLanguage === 'vi' ? 'Thời gian (ms)' : 'Time (ms)', type: 'number', placeholder: '1000' }] },
                    'waitElement': { icon: 'fa-binoculars text-blue-500 dark:text-blue-400', name: lang.waitElement, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#loading-spinner' }] },
                    'getText': { icon: 'fa-quote-left text-rose-500 dark:text-rose-400', name: lang.getText, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'h1' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'pageTitle' }] },
                    'getAttribute': { icon: 'fa-at text-lime-500 dark:text-lime-400', name: lang.getAttribute, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'a.product' }, { id: 'attribute', label: currentLanguage === 'vi' ? 'Tên thuộc tính' : 'Attribute Name', type: 'text', placeholder: 'href' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'productUrl' }] },
                    'getInputValue': { icon: 'fa-i-cursor text-purple-500 dark:text-purple-400', name: lang.getInputValue, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#firstname' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'firstName' }] },
                    'screenshot': { icon: 'fa-camera text-gray-500 dark:text-gray-400', name: lang.screenshot, params: [{ id: 'filename', label: currentLanguage === 'vi' ? 'Tên tệp' : 'Filename', type: 'text', placeholder: 'screenshot.png' }, { id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn (tùy chọn)' : 'Selector (optional)', type: 'selector', placeholder: currentLanguage === 'vi' ? 'Chụp 1 phần tử' : 'Capture element' }] },
                    'sessionCache': { icon: 'fa-memory text-orange-500 dark:text-orange-400', name: lang.sessionCache, params: [
                        { id: 'cacheName', label: currentLanguage === 'vi' ? 'Tên Cache' : 'Cache Name', type: 'text', placeholder: 'user_session' },
                        { id: 'inputCapture', label: currentLanguage === 'vi' ? 'Lưu Input Elements' : 'Input Elements Capture', type: 'textarea', placeholder: '#phoneNumber -> phone\n#email -> email\n#username -> user_name' },
                        { id: 'fromPreviousNodes', label: currentLanguage === 'vi' ? 'Lấy từ node trước' : 'From Previous Nodes', type: 'textarea', placeholder: '{{getText_1.text}} -> extracted_text\n{{getAttribute_1.value}} -> page_url\n{{inputText_1.value}} -> user_input' },
                        { id: 'systemData', label: currentLanguage === 'vi' ? 'Dữ liệu hệ thống' : 'System Data', type: 'textarea', placeholder: 'current_url -> page_url\ntimestamp -> login_time\npage_title -> page_name' },
                        { id: 'customData', label: currentLanguage === 'vi' ? 'Dữ liệu tùy chỉnh' : 'Custom Data', type: 'textarea', placeholder: 'browser_type -> chrome\ndevice_type -> desktop\nsource -> automation' }
                    ] },
                    'customApiRequest': { icon: 'fa-paper-plane text-blue-500 dark:text-blue-400', name: lang.customApiRequest, params: [
                        { id: 'method', label: currentLanguage === 'vi' ? 'Phương thức' : 'Method', type: 'select', options: [
                            { value: 'GET', text: 'GET' },
                            { value: 'POST', text: 'POST' },
                            { value: 'PUT', text: 'PUT' },
                            { value: 'DELETE', text: 'DELETE' }
                        ], value: 'POST' },
                        { id: 'url', label: 'API URL', type: 'text', placeholder: 'https://api.example.com/user/register' },
                        { id: 'headers', label: 'Headers', type: 'textarea', placeholder: '{\n  "Content-Type": "application/json",\n  "Authorization": "Bearer YOUR_TOKEN"\n}' },
                        { id: 'bodyTemplate', label: currentLanguage === 'vi' ? 'Body Template' : 'Body Template', type: 'textarea', placeholder: '{\n  "phone": "{{sessionCache_1.phone}}",\n  "loginTime": "{{sessionCache_1.login_time}}",\n  "pageUrl": "{{sessionCache_1.page_url}}",\n  "extractedData": "{{getText_1.text}}",\n  "userInput": "{{inputText_1.value}}"\n}' },
                        { id: 'cacheReferences', label: currentLanguage === 'vi' ? 'Tham chiếu từ các Node' : 'Node References', type: 'textarea', placeholder: '{{sessionCache_1.phone}}\n{{sessionCache_1.login_time}}\n{{getText_1.text}}\n{{inputText_1.value}}' },
                        { id: 'outputCacheName', label: currentLanguage === 'vi' ? 'Lưu response vào cache' : 'Save response to cache', type: 'text', placeholder: 'api_response' },
                        { id: 'responseMapping', label: currentLanguage === 'vi' ? 'Mapping response' : 'Response mapping', type: 'textarea', placeholder: 'data.userId -> user_id\ndata.status -> api_status\ndata.token -> auth_token' }
                    ] },
                    'responseProcessor': { icon: 'fa-cogs text-green-500 dark:text-green-400', name: lang.responseProcessor, params: [
                        { id: 'inputSource', label: currentLanguage === 'vi' ? 'Lấy từ Node' : 'Input from Node', type: 'text', placeholder: '{{apiRequest_1.response}}' },
                        { id: 'extractAndSave', label: currentLanguage === 'vi' ? 'Trích xuất và lưu' : 'Extract and save', type: 'textarea', placeholder: 'data.userId -> user_id\ndata.status -> api_status\ndata.profile.name -> user_name\ndata.token -> auth_token' },
                        { id: 'outputCacheName', label: currentLanguage === 'vi' ? 'Lưu vào cache' : 'Output cache name', type: 'text', placeholder: 'processed_data' },
                        { id: 'validationRules', label: currentLanguage === 'vi' ? 'Quy tắc validate' : 'Validation rules', type: 'textarea', placeholder: 'REQUIRED: data.userId\nREQUIRED: data.status\nEQUALS: data.status -> success\nNOT_EMPTY: data.token' },
                        { id: 'onValidationFail', label: currentLanguage === 'vi' ? 'Khi validate thất bại' : 'On validation fail', type: 'select', options: [
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' },
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục' : 'Continue' },
                            { value: 'retry', text: currentLanguage === 'vi' ? 'Thử lại' : 'Retry' }
                        ], value: 'stop' }
                    ] },
                    'storageSettings': { icon: 'fa-hdd text-purple-500 dark:text-purple-400', name: lang.storageSettings, params: [
                        { id: 'storageType', label: currentLanguage === 'vi' ? 'Loại lưu trữ' : 'Storage type', type: 'select', options: [
                            { value: 'database', text: 'Database' },
                            { value: 'excel', text: 'Excel File' },
                            { value: 'both', text: currentLanguage === 'vi' ? 'Cả hai' : 'Both' }
                        ], value: 'database' },
                        { id: 'inputSources', label: currentLanguage === 'vi' ? 'Nguồn dữ liệu từ các Node' : 'Data sources from Nodes', type: 'textarea', placeholder: '{{sessionCache_1}}\n{{processResponse_1}}\n{{apiRequest_1}}' },
                        { id: 'databaseConfig', label: currentLanguage === 'vi' ? 'Cấu hình Database' : 'Database config', type: 'textarea', placeholder: 'Server: localhost:3306\nDatabase: userdb\nTable: registered_users\nUsername: dbuser\nPassword: dbpass' },
                        { id: 'excelConfig', label: currentLanguage === 'vi' ? 'Cấu hình Excel' : 'Excel config', type: 'textarea', placeholder: 'File: /path/to/users.xlsx\nSheet: UserData\nStartRow: 1' },
                        { id: 'dataMapping', label: currentLanguage === 'vi' ? 'Ánh xạ dữ liệu' : 'Data mapping', type: 'textarea', placeholder: '{{sessionCache_1.phone}} -> phone_column\n{{processResponse_1.user_id}} -> user_id_column\n{{sessionCache_1.login_time}} -> created_at' },
                        { id: 'onSuccess', label: currentLanguage === 'vi' ? 'Khi thành công' : 'On success', type: 'select', options: [
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục workflow' : 'Continue workflow' },
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' },
                            { value: 'notification', text: currentLanguage === 'vi' ? 'Gửi thông báo' : 'Send notification' }
                        ], value: 'continue' }
                    ] },
                    'checkNodeExists': { icon: 'fa-search text-cyan-500 dark:text-cyan-400', name: lang.checkNodeExists, params: [
                        { id: 'nodeId', label: currentLanguage === 'vi' ? 'Node ID cần kiểm tra' : 'Node ID to check', type: 'text', placeholder: 'sessionCache_1' },
                        { id: 'outputField', label: currentLanguage === 'vi' ? 'Field cần kiểm tra (tùy chọn)' : 'Output field to check (optional)', type: 'text', placeholder: 'phone' },
                        { id: 'onNotExists', label: currentLanguage === 'vi' ? 'Khi không tồn tại' : 'When not exists', type: 'select', options: [
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' },
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục' : 'Continue' },
                            { value: 'log', text: currentLanguage === 'vi' ? 'Ghi log' : 'Log only' }
                        ], value: 'stop' }
                    ] },
                    'checkNodeValue': { icon: 'fa-check-circle text-teal-500 dark:text-teal-400', name: lang.checkNodeValue, params: [
                        { id: 'nodeReference', label: currentLanguage === 'vi' ? 'Tham chiếu Node' : 'Node reference', type: 'text', placeholder: '{{sessionCache_1.phone}}' },
                        { id: 'operator', label: currentLanguage === 'vi' ? 'Toán tử so sánh' : 'Comparison operator', type: 'select', options: [
                            { value: 'equals', text: 'Equals (=)' },
                            { value: 'notEquals', text: 'Not Equals (!=)' },
                            { value: 'contains', text: 'Contains' },
                            { value: 'notEmpty', text: 'Not Empty' },
                            { value: 'isEmpty', text: 'Is Empty' },
                            { value: 'greater', text: 'Greater (>)' },
                            { value: 'less', text: 'Less (<)' }
                        ], value: 'notEmpty' },
                        { id: 'expectedValue', label: currentLanguage === 'vi' ? 'Giá trị mong đợi' : 'Expected value', type: 'text', placeholder: '0123456789' },
                        { id: 'onValidationFail', label: currentLanguage === 'vi' ? 'Khi validate thất bại' : 'On validation fail', type: 'select', options: [
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' },
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục' : 'Continue' },
                            { value: 'retry', text: currentLanguage === 'vi' ? 'Thử lại' : 'Retry' }
                        ], value: 'stop' }
                    ] },
                    'getNodeList': { icon: 'fa-list text-indigo-500 dark:text-indigo-400', name: lang.getNodeList, params: [
                        { id: 'filterByType', label: currentLanguage === 'vi' ? 'Lọc theo loại node' : 'Filter by node type', type: 'select', options: [
                            { value: 'all', text: currentLanguage === 'vi' ? 'Tất cả' : 'All' },
                            { value: 'sessionCache', text: 'Session Cache' },
                            { value: 'customApiRequest', text: 'API Request' },
                            { value: 'responseProcessor', text: 'Response Processor' },
                            { value: 'storageSettings', text: 'Storage Settings' },
                            { value: 'getText', text: 'Get Text' },
                            { value: 'getAttribute', text: 'Get Attribute' }
                        ], value: 'all' },
                        { id: 'outputFormat', label: currentLanguage === 'vi' ? 'Định dạng output' : 'Output format', type: 'select', options: [
                            { value: 'list', text: currentLanguage === 'vi' ? 'Danh sách' : 'List' },
                            { value: 'json', text: 'JSON' },
                            { value: 'count', text: currentLanguage === 'vi' ? 'Đếm số lượng' : 'Count only' }
                        ], value: 'list' },
                        { id: 'saveToVariable', label: currentLanguage === 'vi' ? 'Lưu vào biến' : 'Save to variable', type: 'text', placeholder: 'nodeList' }
                    ] },
                    'validateNodeData': { icon: 'fa-shield-alt text-emerald-500 dark:text-emerald-400', name: lang.validateNodeData, params: [
                        { id: 'nodeReferences', label: currentLanguage === 'vi' ? 'Danh sách Node cần validate' : 'Node references to validate', type: 'textarea', placeholder: '{{sessionCache_1.phone}}\n{{apiRequest_1.response}}\n{{processResponse_1.user_id}}' },
                        { id: 'validationRules', label: currentLanguage === 'vi' ? 'Quy tắc validate' : 'Validation rules', type: 'textarea', placeholder: 'REQUIRED: {{sessionCache_1.phone}}\nNOT_EMPTY: {{apiRequest_1.response}}\nMATCH_PATTERN: {{sessionCache_1.phone}} -> /^\\d{10}$/\nRANGE: {{processResponse_1.user_id}} -> 1-999999' },
                        { id: 'onValidationPass', label: currentLanguage === 'vi' ? 'Khi validate thành công' : 'On validation pass', type: 'select', options: [
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục workflow' : 'Continue workflow' },
                            { value: 'log', text: currentLanguage === 'vi' ? 'Ghi log' : 'Log only' }
                        ], value: 'continue' },
                        { id: 'onValidationFail', label: currentLanguage === 'vi' ? 'Khi validate thất bại' : 'On validation fail', type: 'select', options: [
                            { value: 'stop', text: currentLanguage === 'vi' ? 'Dừng workflow' : 'Stop workflow' },
                            { value: 'continue', text: currentLanguage === 'vi' ? 'Tiếp tục' : 'Continue' },
                            { value: 'retry', text: currentLanguage === 'vi' ? 'Thử lại' : 'Retry' }
                        ], value: 'stop' }
                    ] },
                    'assertVisible': { icon: 'fa-eye text-green-500 dark:text-green-400', name: lang.assertVisible, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.welcome-message' }] },
                    'assertText': { icon: 'fa-check-double text-yellow-500 dark:text-yellow-400', name: lang.assertText, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'h1' }, { id: 'text', label: currentLanguage === 'vi' ? 'Văn bản mong muốn' : 'Expected Text', type: 'text', placeholder: currentLanguage === 'vi' ? 'Chào mừng' : 'Welcome' }] },
                    'assertURL': { icon: 'fa-link text-blue-500 dark:text-blue-400', name: lang.assertURL, params: [{ id: 'expectedURL', label: currentLanguage === 'vi' ? 'URL mong muốn' : 'Expected URL', type: 'text', placeholder: 'https://example.com/dashboard' }] },
                    'assertTitle': { icon: 'fa-heading text-purple-500 dark:text-purple-400', name: lang.assertTitle, params: [{ id: 'expectedTitle', label: currentLanguage === 'vi' ? 'Tiêu đề mong muốn' : 'Expected Title', type: 'text', placeholder: 'Welcome Page' }] },
                    'assertAttribute': { icon: 'fa-tags text-orange-500 dark:text-orange-400', name: lang.assertAttribute, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'input[name="email"]' }, { id: 'attribute', label: currentLanguage === 'vi' ? 'Tên thuộc tính' : 'Attribute Name', type: 'text', placeholder: 'type' }, { id: 'expectedValue', label: currentLanguage === 'vi' ? 'Giá trị mong muốn' : 'Expected Value', type: 'text', placeholder: 'email' }] },
                    'assertElementCount': { icon: 'fa-list-ol text-indigo-500 dark:text-indigo-400', name: lang.assertElementCount, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.product-card' }, { id: 'operator', label: currentLanguage === 'vi' ? 'Toán tử' : 'Operator', type: 'select', options: [{ value: 'equals', text: 'Equals (=)' }, { value: 'greater', text: 'Greater (>)' }, { value: 'less', text: 'Less (<)' }, { value: 'greaterEqual', text: 'Greater Equal (>=)' }, { value: 'lessEqual', text: 'Less Equal (<=)' }] }, { id: 'expectedCount', label: currentLanguage === 'vi' ? 'Số lượng' : 'Count', type: 'number', placeholder: '10' }] },
                    'assertNotVisible': { icon: 'fa-eye-slash text-red-500 dark:text-red-400', name: lang.assertNotVisible, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.loading-spinner' }] },
                    'assertEnabled': { icon: 'fa-toggle-on text-teal-500 dark:text-teal-400', name: lang.assertEnabled, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#submit-button' }] },
                    'assertDisabled': { icon: 'fa-toggle-off text-gray-500 dark:text-gray-400', name: lang.assertDisabled, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#submit-button' }] },
                    'assertChecked': { icon: 'fa-check-square text-emerald-500 dark:text-emerald-400', name: lang.assertChecked, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#terms-checkbox' }] },
                    'assertUnchecked': { icon: 'fa-square text-pink-500 dark:text-pink-400', name: lang.assertUnchecked, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#newsletter-checkbox' }] },
                    'assertContainsText': { icon: 'fa-search text-cyan-500 dark:text-cyan-400', name: lang.assertContainsText, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.error-message' }, { id: 'containsText', label: currentLanguage === 'vi' ? 'Văn bản chứa' : 'Contains Text', type: 'text', placeholder: 'required field' }] },
                    'assertCSSProperty': { icon: 'fab fa-css3-alt text-violet-500 dark:text-violet-400', name: lang.assertCSSProperty, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.button' }, { id: 'property', label: currentLanguage === 'vi' ? 'Thuộc tính CSS' : 'CSS Property', type: 'text', placeholder: 'color' }, { id: 'expectedValue', label: currentLanguage === 'vi' ? 'Giá trị mong muốn' : 'Expected Value', type: 'text', placeholder: 'rgb(0, 0, 255)' }] },
                    'validateForm': { icon: 'fa-clipboard-check text-amber-500 dark:text-amber-400', name: lang.validateForm, params: [{ id: 'formSelector', label: currentLanguage === 'vi' ? 'Bộ chọn Form' : 'Form Selector', type: 'selector', placeholder: '#registration-form' }, { id: 'validationType', label: currentLanguage === 'vi' ? 'Loại kiểm tra' : 'Validation Type', type: 'select', options: [{ value: 'required', text: 'Required Fields' }, { value: 'format', text: 'Format Validation' }, { value: 'length', text: 'Length Validation' }] }] },
                    'checkBrokenLinks': { icon: 'fa-unlink text-rose-500 dark:text-rose-400', name: lang.checkBrokenLinks, params: [{ id: 'scope', label: currentLanguage === 'vi' ? 'Phạm vi kiểm tra' : 'Check Scope', type: 'select', options: [{ value: 'current-page', text: 'Current Page' }, { value: 'all-links', text: 'All Links' }, { value: 'internal-only', text: 'Internal Links Only' }] }] },
                    'checkImageLoading': { icon: 'fa-image text-lime-500 dark:text-lime-400', name: lang.checkImageLoading, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn (tùy chọn)' : 'Selector (optional)', type: 'selector', placeholder: currentLanguage === 'vi' ? 'Tất cả hình ảnh' : 'All images' }] },
                    'checkPageSpeed': { icon: 'fa-tachometer-alt text-sky-500 dark:text-sky-400', name: lang.checkPageSpeed, params: [{ id: 'metric', label: currentLanguage === 'vi' ? 'Chỉ số' : 'Metric', type: 'select', options: [{ value: 'load-time', text: 'Load Time' }, { value: 'first-paint', text: 'First Paint' }, { value: 'largest-contentful-paint', text: 'Largest Contentful Paint' }, { value: 'dom-content-loaded', text: 'DOM Content Loaded' }, { value: 'time-to-interactive', text: 'Time to Interactive' }] }, { id: 'threshold', label: currentLanguage === 'vi' ? 'Ngưỡng (ms)' : 'Threshold (ms)', type: 'number', placeholder: '3000' }, { id: 'timeout', label: currentLanguage === 'vi' ? 'Timeout (s)' : 'Timeout (s)', type: 'number', placeholder: '30' }] },
                    'checkResponsive': { icon: 'fa-mobile-alt text-slate-500 dark:text-slate-400', name: lang.checkResponsive, params: [{ id: 'devices', label: currentLanguage === 'vi' ? 'Thiết bị' : 'Devices', type: 'select', options: [{ value: 'mobile', text: 'Mobile' }, { value: 'tablet', text: 'Tablet' }, { value: 'desktop', text: 'Desktop' }, { value: 'all', text: 'All Devices' }] }] },
                    'checkAccessibility': { icon: 'fa-universal-access text-green-500 dark:text-green-400', name: lang.checkAccessibility, params: [{ id: 'level', label: currentLanguage === 'vi' ? 'Cấp độ WCAG' : 'WCAG Level', type: 'select', options: [{ value: 'A', text: 'Level A' }, { value: 'AA', text: 'Level AA' }, { value: 'AAA', text: 'Level AAA' }] }, { id: 'scope', label: currentLanguage === 'vi' ? 'Phạm vi' : 'Scope', type: 'select', options: [{ value: 'full-page', text: 'Full Page' }, { value: 'element', text: 'Specific Element' }] }, { id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn (tùy chọn)' : 'Selector (optional)', type: 'selector', placeholder: '.main-content' }] },
                    'checkSEO': { icon: 'fa-search-plus text-yellow-500 dark:text-yellow-400', name: lang.checkSEO, params: [{ id: 'checks', label: currentLanguage === 'vi' ? 'Kiểm tra' : 'Checks', type: 'select', options: [{ value: 'meta-tags', text: 'Meta Tags' }, { value: 'headings', text: 'Heading Structure' }, { value: 'alt-text', text: 'Alt Text' }, { value: 'all', text: 'All SEO Checks' }] }] },
                    'interceptNetwork': { icon: 'fa-ban text-red-500 dark:text-red-400', name: lang.interceptNetwork, params: [{ id: 'url', label: currentLanguage === 'vi' ? 'URL Pattern' : 'URL Pattern', type: 'text', placeholder: '*/api/users*' }, { id: 'action', label: currentLanguage === 'vi' ? 'Hành động' : 'Action', type: 'select', options: [{ value: 'block', text: 'Block' }, { value: 'delay', text: 'Delay' }, { value: 'modify', text: 'Modify Response' }] }] },
                    'mockAPI': { icon: 'fa-cloud text-purple-500 dark:text-purple-400', name: lang.mockAPI, params: [{ id: 'endpoint', label: currentLanguage === 'vi' ? 'API Endpoint' : 'API Endpoint', type: 'text', placeholder: '/api/users' }, { id: 'method', label: currentLanguage === 'vi' ? 'Phương thức' : 'Method', type: 'select', options: [{ value: 'GET', text: 'GET' }, { value: 'POST', text: 'POST' }, { value: 'PUT', text: 'PUT' }, { value: 'DELETE', text: 'DELETE' }] }, { id: 'responseBody', label: currentLanguage === 'vi' ? 'Phản hồi Mock' : 'Mock Response', type: 'textarea', placeholder: '{"users": []}' }] },
                    'setCookie': { icon: 'fa-cookie-bite text-orange-500 dark:text-orange-400', name: lang.setCookie, params: [{ id: 'name', label: currentLanguage === 'vi' ? 'Tên Cookie' : 'Cookie Name', type: 'text', placeholder: 'session_id' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: 'abc123' }, { id: 'domain', label: currentLanguage === 'vi' ? 'Domain (tùy chọn)' : 'Domain (optional)', type: 'text', placeholder: '.example.com' }] },
                    'checkConsoleErrors': { icon: 'fa-exclamation-triangle text-red-500 dark:text-red-400', name: lang.checkConsoleErrors, params: [{ id: 'level', label: currentLanguage === 'vi' ? 'Cấp độ' : 'Level', type: 'select', options: [{ value: 'error', text: 'Error' }, { value: 'warning', text: 'Warning' }, { value: 'all', text: 'All Levels' }] }] },
                    'checkMemoryUsage': { icon: 'fa-memory text-blue-500 dark:text-blue-400', name: lang.checkMemoryUsage, params: [{ id: 'threshold', label: currentLanguage === 'vi' ? 'Ngưỡng (MB)' : 'Threshold (MB)', type: 'number', placeholder: '100' }] },
                    'checkLocalStorage': { icon: 'fa-database text-teal-500 dark:text-teal-400', name: lang.checkLocalStorage, params: [{ id: 'key', label: currentLanguage === 'vi' ? 'Key (tùy chọn)' : 'Key (optional)', type: 'text', placeholder: 'user_preferences' }, { id: 'expectedValue', label: currentLanguage === 'vi' ? 'Giá trị mong muốn (tùy chọn)' : 'Expected Value (optional)', type: 'text', placeholder: '{"theme": "dark"}' }] },
                    'checkSessionStorage': { icon: 'fa-archive text-indigo-500 dark:text-indigo-400', name: lang.checkSessionStorage, params: [{ id: 'key', label: currentLanguage === 'vi' ? 'Key (tùy chọn)' : 'Key (optional)', type: 'text', placeholder: 'cart_items' }, { id: 'expectedValue', label: currentLanguage === 'vi' ? 'Giá trị mong muốn (tùy chọn)' : 'Expected Value (optional)', type: 'text', placeholder: '[]' }] },
                    'testCrossBrowser': { icon: 'fab fa-firefox-browser text-green-500 dark:text-green-400', name: lang.testCrossBrowser, params: [{ id: 'browsers', label: currentLanguage === 'vi' ? 'Trình duyệt' : 'Browsers', type: 'select', options: [{ value: 'chrome', text: 'Chrome' }, { value: 'firefox', text: 'Firefox' }, { value: 'safari', text: 'Safari' }, { value: 'edge', text: 'Edge' }, { value: 'all', text: 'All Browsers' }] }] },
                    'simulateNetworkCondition': { icon: 'fa-wifi text-yellow-500 dark:text-yellow-400', name: lang.simulateNetworkCondition, params: [{ id: 'condition', label: currentLanguage === 'vi' ? 'Điều kiện' : 'Condition', type: 'select', options: [{ value: 'offline', text: 'Offline' }, { value: 'slow-3g', text: 'Slow 3G' }, { value: 'fast-3g', text: 'Fast 3G' }, { value: 'fast-4g', text: 'Fast 4G' }, { value: 'custom', text: 'Custom' }] }, { id: 'downloadSpeed', label: currentLanguage === 'vi' ? 'Tốc độ tải xuống (Kbps)' : 'Download Speed (Kbps)', type: 'number', placeholder: '1600' }, { id: 'uploadSpeed', label: currentLanguage === 'vi' ? 'Tốc độ tải lên (Kbps)' : 'Upload Speed (Kbps)', type: 'number', placeholder: '750' }, { id: 'latency', label: currentLanguage === 'vi' ? 'Độ trễ (ms)' : 'Latency (ms)', type: 'number', placeholder: '150' }] }
                };
            };

            function createNode(type, x, y, customId = null) {
                const id = customId || generateNodeId(type);
                const node = { id, type, x, y, params: {}, displayName: id };
                const actionConfig = getActionConfig();
                if (actionConfig[type] && actionConfig[type].params) {
                    actionConfig[type].params.forEach(p => {
                        node.params[p.id] = p.options ? p.options[0].value : '';
                    });
                }
                return node;
            }

            const getPortTooltips = () => {
                const lang = translations[currentLanguage];
                return {
                    'in': lang.input,
                    'out': lang.output,
                    'then': lang.then,
                    'else': lang.else,
                    'next': lang.next,
                    'loopBody': lang.loopBody,
                    'in_top': lang.input,
                    'in_left': lang.input,
                    'out_right': lang.output,
                    'out_bottom': lang.output,
                };
            };
            const createPortWithTooltip = (position, type, name) => {
                const portTooltips = getPortTooltips();
                const tooltipText = portTooltips[name] || name;
                return `<div class="node-port ${position} ${type}-port" data-port-name="${name}"></div><span class="port-tooltip">${tooltipText}</span>`;
            };

            function renderNodes() {
                nodeContainer.innerHTML = '';
                nodes.forEach(node => {
                    const actionConfig = getActionConfig();
                    const config = actionConfig[node.type];
                    if (!config) return;
                    const el = document.createElement('div');
                    el.id = node.id;
                    const isSelected = node.id === selectedNodeId;
                    el.className = `workflow-node bg-white dark:bg-gray-700 border border-slate-200 dark:border-gray-600 text-slate-800 dark:text-gray-200 ${isSelected ? 'selected-node' : ''}`;
                    el.style.left = `${node.x}px`;
                    el.style.top = `${node.y}px`;

                    let contentHTML = `<div class="node-header border-b border-slate-200 dark:border-gray-600">
                        <div><i class="fas ${config.icon} mr-2"></i>${config.name}</div>
                        <div class="text-xs text-slate-300 dark:text-gray-400 mt-0.5 font-mono italic font-normal">#${node.displayName || node.id}</div>
                    </div>`;
                    if (config.params.length > 0) {
                        const summary = Object.values(node.params).find(v => v) || (currentLanguage === 'vi' ? 'Chưa cấu hình' : 'Not configured');
                        contentHTML += `<div class="node-content text-slate-600 dark:text-gray-400 text-xs truncate"><strong>${config.params[0].label}:</strong> ${summary}</div>`;
                    }
                    el.innerHTML = contentHTML;

                    let portsHTML = '';
                    let labelsHTML = '';

                    switch (node.type) {
                        case 'start':
                            portsHTML = createPortWithTooltip('port-right', 'output', 'out');
                            break;
                        case 'stop':
                            portsHTML = createPortWithTooltip('port-left', 'input', 'in');
                            break;
                        case 'comment':
                            portsHTML = '';
                            break;
                        case 'if':
                        case 'advancedCondition':
                            portsHTML = `${createPortWithTooltip('port-left', 'input', 'in')}${createPortWithTooltip('port-if-then', 'output', 'then')}${createPortWithTooltip('port-if-else', 'output', 'else')}`;
                            labelsHTML = `<span class="port-label label-then text-green-500">THEN</span><span class="port-label label-else text-red-500">ELSE</span>`;
                            break;
                        case 'forEach':
                            portsHTML = `${createPortWithTooltip('port-left', 'input', 'in')}${createPortWithTooltip('port-right', 'output', 'next')}${createPortWithTooltip('port-bottom', 'output', 'loopBody')}`;
                            labelsHTML = `<span class="port-label text-green-500" style="top: 50%; right: 14px; transform: translateY(-50%);">NEXT</span><span class="port-label text-purple-500" style="bottom: -24px; left: 50%; transform: translateX(-50%);">LOOP</span>`;
                            break;
                        default:
                            portsHTML = `${createPortWithTooltip('port-top', 'input', 'in_top')}${createPortWithTooltip('port-left', 'input', 'in_left')}${createPortWithTooltip('port-right', 'output', 'out_right')}${createPortWithTooltip('port-bottom', 'output', 'out_bottom')}`;
                            break;
                    }
                    el.innerHTML += portsHTML + labelsHTML;

                    el.addEventListener('mousedown', e => onNodeMouseDown(e, node));
                    el.querySelectorAll('.node-port').forEach(p => p.addEventListener('mousedown', onPortMouseDown));
                    nodeContainer.appendChild(el);
                });
            }

            function drawCurve(x1, y1, x2, y2) {
                const handleOffset = Math.max(50, Math.abs(x2 - x1) * 0.4);
                return `M ${x1},${y1} C ${x1 + handleOffset},${y1} ${x2 - handleOffset},${y2} ${x2},${y2}`;
            }

            function getPortPosition(nodeId, portName) {
                const portEl = document.querySelector(`#${nodeId} [data-port-name="${portName}"]`);
                if (!portEl) return null;
                const node = nodes.find(n => n.id === nodeId);
                if (!node) return null;


                const nodeWidth = 220;


                const actionConfig = getActionConfig();
                const config = actionConfig[node.type];
                
                // Get actual node height from DOM element
                const nodeElement = document.getElementById(node.id);
                let nodeHeight = 40; // fallback
                if (nodeElement) {
                    nodeHeight = nodeElement.offsetHeight;
                } else {
                    // Fallback calculation if element not found
                    nodeHeight = 40;
                    if (config && config.params && config.params.length > 0) {
                        nodeHeight += 44;
                    }
                }

                let portOffsetX = 0;
                let portOffsetY = 0;



                if (portEl.classList.contains('port-left')) {
                    portOffsetX = 0;
                    portOffsetY = nodeHeight / 2;
                } else if (portEl.classList.contains('port-right')) {
                    portOffsetX = nodeWidth;
                    portOffsetY = nodeHeight / 2;
                } else if (portEl.classList.contains('port-top')) {
                    portOffsetX = nodeWidth / 2;
                    portOffsetY = 0;
                } else if (portEl.classList.contains('port-bottom')) {
                    portOffsetX = nodeWidth / 2;
                    portOffsetY = nodeHeight;
                } else if (portEl.classList.contains('port-if-then')) {
                    portOffsetX = nodeWidth;
                    portOffsetY = nodeHeight * 0.33;
                } else if (portEl.classList.contains('port-if-else')) {
                    portOffsetX = nodeWidth;
                    portOffsetY = nodeHeight * 0.67;
                }

                return {
                    x: node.x + portOffsetX,
                    y: node.y + portOffsetY
                };
            }

            function renderConnections() {

                const defs = svg.querySelector('defs');
                svg.innerHTML = '';
                if (defs) svg.appendChild(defs);

                connections.forEach((conn, index) => {
                    const startPos = getPortPosition(conn.fromNode, conn.fromPort);
                    const endPos = getPortPosition(conn.toNode, conn.toPort);
                    if (!startPos || !endPos) return;

                    const d = drawCurve(startPos.x, startPos.y, endPos.x, endPos.y);
                    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    group.classList.add('connector-group');
                    group.setAttribute('data-connection-index', index);


                    if (dragInfo.type === 'connection_active' && dragInfo.index === index) {
                        group.style.display = 'none';
                    }

                    const hitbox = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    hitbox.setAttribute('d', d);
                    hitbox.classList.add('connector-hitbox');

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', d);
                    path.classList.add('connector-path', 'stroke-slate-400', 'dark:stroke-gray-500');
                    path.setAttribute('marker-end', 'url(#end-circle)');

                    group.appendChild(hitbox);
                    group.appendChild(path);
                    group.addEventListener('mousedown', (e) => onConnectionPathMouseDown(e, conn, index));
                    group.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        connections.splice(index, 1);
                        renderAll();
                    });
                    svg.appendChild(group);
                });


                if (tempConnection.path && tempConnection.path.parentNode !== svg) {
                    svg.appendChild(tempConnection.path);
                }
            }

            function onMouseMove(e) {
                if (dragInfo.type === 'connection') {
                    const dx = e.clientX - dragInfo.startX;
                    const dy = e.clientY - dragInfo.startY;
                    if (Math.sqrt(dx * dx + dy * dy) > 3) {
                        dragInfo.type = 'connection_active';
                        tempConnection.active = true;
                        tempConnection.startNode = dragInfo.connection.fromNode;
                        tempConnection.startPort = dragInfo.connection.fromPort;
                        const startPos = getPortPosition(tempConnection.startNode, tempConnection.startPort);
                        if (startPos) {

                            if (tempConnection.path) {
                                tempConnection.path.remove();
                            }
                            tempConnection.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            tempConnection.path.setAttribute('d', drawCurve(startPos.x, startPos.y, startPos.x, startPos.y));
                            tempConnection.path.classList.add('connector-path-temp');
                            tempConnection.path.setAttribute('marker-end', 'url(#end-circle-temp)');
                            tempConnection.path.style.pointerEvents = 'none';
                            svg.appendChild(tempConnection.path);
                            renderConnections();
                        }
                    }
                }
                if (dragInfo.type === 'node') {
                    const rect = canvasContainer.getBoundingClientRect();
                    dragInfo.target.x = (e.clientX - rect.left - panX) / scale - dragInfo.offsetX;
                    dragInfo.target.y = (e.clientY - rect.top - panY) / scale - dragInfo.offsetY;
                    renderAll();
                }
                if (isPanning) {
                    panX += e.clientX - panStart.x;
                    panY += e.clientY - panStart.y;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                    applyTransform();
                }
                if (tempConnection.active && tempConnection.path) {

                    document.querySelectorAll('.workflow-node').forEach(node => {
                        node.classList.add('show-ports');
                    });

                    const startPos = getPortPosition(tempConnection.startNode, tempConnection.startPort);
                    if (!startPos) return;
                    const canvasRect = canvasContainer.getBoundingClientRect();
                    const endX = (e.clientX - canvasRect.left - panX) / scale;
                    const endY = (e.clientY - canvasRect.top - panY) / scale;


                    tempConnection.path.setAttribute('d', drawCurve(startPos.x, startPos.y, endX, endY));


                    const endPort = e.target.closest('.node-port');
                    tempConnection.path.classList.remove('valid-target', 'invalid-target');
                    let isValidTarget = false;

                    if (endPort && window.getComputedStyle(endPort).visibility === 'visible') {
                        const endNodeId = endPort.closest('.workflow-node').id;
                        const isInputPort = endPort.classList.contains('input-port');
                        const isDifferentNode = endNodeId !== tempConnection.startNode;

                        if (isInputPort && isDifferentNode) {

                            const isNodeInputOccupied = connections.some((c, i) => {
                                return (dragInfo.type !== 'connection_active' || dragInfo.index !== i) && c.toNode === endNodeId;
                            });
                            if (!isNodeInputOccupied) {
                                isValidTarget = true;
                            }
                        }
                    }


                    if (isValidTarget) {
                        tempConnection.path.classList.add('valid-target');
                        tempConnection.path.setAttribute('marker-end', 'url(#end-circle-valid)');
                    } else if (endPort) {
                        tempConnection.path.classList.add('invalid-target');
                        tempConnection.path.setAttribute('marker-end', 'url(#end-circle-invalid)');
                    } else {
                        tempConnection.path.setAttribute('marker-end', 'url(#end-circle-temp)');
                    }
                }
            }

            function onMouseUp(e) {
                if (tempConnection.active) {
                    const endPort = e.target.closest('.node-port');
                    let isValidTarget = false;
                    if (endPort && window.getComputedStyle(endPort).visibility === 'visible') {
                        const endNodeId = endPort.closest('.workflow-node').id;
                        const isInputPort = endPort.classList.contains('input-port');
                        const isDifferentNode = endNodeId !== tempConnection.startNode;
                        if (isInputPort && isDifferentNode) {

                            const isNodeInputOccupied = connections.some((c, i) => {
                                return (dragInfo.type !== 'connection_active' || dragInfo.index !== i) && c.toNode === endNodeId;
                            });
                            if (!isNodeInputOccupied) {
                                isValidTarget = true;
                            }
                        }
                    }
                    if (isValidTarget) {
                        const newConnection = { fromNode: tempConnection.startNode, fromPort: tempConnection.startPort, toNode: endPort.closest('.workflow-node').id, toPort: endPort.dataset.portName };
                        if (dragInfo.type === 'connection_active') {
                            connections.splice(dragInfo.index, 1, newConnection);
                        } else {
                            connections.push(newConnection);
                        }
                    } else if (dragInfo.type === 'connection_active') {

                        connections.splice(dragInfo.index, 1);
                    }

                    if (tempConnection.path) {
                        tempConnection.path.remove();
                        tempConnection.path = null;
                    }
                    tempConnection.active = false;


                    document.querySelectorAll('.workflow-node').forEach(node => {
                        if (!node.classList.contains('selected-node')) {
                            node.classList.remove('show-ports');
                        }
                    });


                    renderNodes();
                    applyTransform();
                    renderConnections();
                    if (!isTesting) renderPropertiesPanel();


                    setTimeout(() => {
                        renderConnections();
                    }, 10);
                }
                dragInfo = {};


                if (!tempConnection.active) {
                    document.querySelectorAll('.workflow-node').forEach(node => {

                        if (!node.classList.contains('selected-node')) {
                            node.classList.remove('show-ports');
                        }
                    });
                }

                if (isPanning) {
                    isPanning = false;
                    canvasContainer.classList.remove('panning');
                }
            }

            function renderAll(data = null) {
                if (data) {
                    nodes = data.nodes;
                    connections = data.connections;
                }
                renderNodes();
                applyTransform();
                renderConnections();
                if (!isTesting) renderPropertiesPanel();
            }

            function onNodeMouseDown(e, node) {
                if (isTesting || e.target.classList.contains('node-port') || isSpacePressed) return;
                selectedNodeId = node.id;


                document.querySelectorAll('.workflow-node').forEach(n => {
                    if (n.id === node.id) {
                        n.classList.add('show-ports');
                    } else {
                        n.classList.remove('show-ports');
                    }
                });

                const rect = canvasContainer.getBoundingClientRect();
                dragInfo = { type: 'node', target: node, offsetX: (e.clientX - rect.left - panX) / scale - node.x, offsetY: (e.clientY - rect.top - panY) / scale - node.y };
                renderAll();
            }

            function onPortMouseDown(e) {
                e.stopPropagation();
                if (isTesting || isSpacePressed) return;
                const port = e.currentTarget;
                const startNodeId = port.closest('.workflow-node').id;
                const startPortName = port.dataset.portName;
                const startNode = nodes.find(n => n.id === startNodeId);
                if (!port.classList.contains('output-port')) return;
                const isStandardNode = !['if', 'forEach'].includes(startNode.type);
                if (isStandardNode) {
                    if (connections.some(c => c.fromNode === startNodeId)) return;
                } else {
                    if (connections.some(c => c.fromNode === startNodeId && c.fromPort === startPortName)) return;
                }
                tempConnection.active = true;
                tempConnection.startNode = startNodeId;
                tempConnection.startPort = startPortName;


                document.querySelectorAll('.workflow-node').forEach(node => {
                    node.classList.add('show-ports');
                });
                const startPos = getPortPosition(tempConnection.startNode, tempConnection.startPort);
                if (!startPos) return;
                if (tempConnection.path) {
                    tempConnection.path.remove();
                }
                tempConnection.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempConnection.path.setAttribute('d', drawCurve(startPos.x, startPos.y, startPos.x, startPos.y));
                tempConnection.path.classList.add('connector-path-temp');
                tempConnection.path.setAttribute('marker-end', 'url(#end-circle-temp)');
                tempConnection.path.style.pointerEvents = 'none';
                svg.appendChild(tempConnection.path);
            }

            function onConnectionPathMouseDown(e, connectionToModify, index) {
                e.preventDefault();
                e.stopPropagation();
                if (isTesting || isSpacePressed) return;
                dragInfo = { type: 'connection', index: index, connection: connectionToModify, startX: e.clientX, startY: e.clientY };
            }


            function getParamHelp(paramId, lang) {
                const helpTexts = {
                    en: {
                        selector: "CSS selector to target HTML elements. Examples: #myId, .myClass, button[type='submit']",
                        url: "Website URL to navigate to. Must include protocol (http:// or https://)",
                        text: "Text content to type, search for, or validate against",
                        condition: "Boolean expression to evaluate. Use variables and operators like ==, !=, >, <",
                        timeout: "Time to wait in milliseconds (1000ms = 1 second)",
                        variable: "Variable name to store extracted data for later use",
                        key: "Keyboard key to press. Examples: Enter, Space, Tab, Escape",
                        value: "Value to input, select, or compare against",
                        attribute: "HTML attribute name like 'href', 'src', 'data-id', 'class'",
                        filename: "File name with extension for saved screenshots or uploads",
                        expectedURL: "Expected URL to verify navigation worked correctly",
                        expectedTitle: "Expected page title text to validate",
                        expectedValue: "Expected value to compare against actual element value",
                        expectedCount: "Expected number of elements matching the selector",
                        containsText: "Partial text that should be found within the element",
                        property: "CSS property name like 'color', 'font-size', 'display'",
                        threshold: "Maximum acceptable value (milliseconds for timing, MB for memory)",
                        operator: "Mathematical comparison operator (=, >, <, >=, <=)",
                        filePath: "Full path to the file to upload, including drive and folders",
                        state: "Whether checkbox should be checked (check) or unchecked (uncheck)",
                        list: "Array variable name or number of iterations for loops",
                        method: "HTTP method for API requests (GET, POST, PUT, DELETE)",
                        endpoint: "API endpoint URL path (e.g., /api/users)",
                        responseBody: "Mock response data in JSON format",
                        formSelector: "CSS selector targeting the form element to validate",
                        validationType: "Type of validation to perform on the form",
                        scope: "Range of elements or pages to check",
                        metric: "Performance metric to measure and validate",
                        devices: "Device types to test responsive design on",
                        level: "WCAG accessibility compliance level to test against",
                        checks: "SEO elements to validate (meta tags, headings, etc.)",
                        action: "What to do when intercepting network requests",
                        name: "Cookie name identifier",
                        domain: "Domain scope for cookie (optional)",
                        key: "Storage key name to check or data key to validate",
                        browsers: "Which browsers to test compatibility across",
                        condition: "Network condition to simulate for testing",
                        downloadSpeed: "Download speed in Kbps for custom network conditions",
                        uploadSpeed: "Upload speed in Kbps for custom network conditions",
                        latency: "Network latency in milliseconds",
                        // Session Cache & API nodes
                        cacheName: "Name for the cache container to store session data",
                        inputCapture: "Map input elements to cache keys (format: #selector -> key)",
                        fromPreviousNodes: "Reference data from previous nodes (format: {{nodeId.field}} -> key)",
                        systemData: "Automatically captured system data (current_url, timestamp, page_title)",
                        customData: "Custom static data to include (format: key -> value)",
                        bodyTemplate: "HTTP request body template using {{nodeId.field}} references",
                        cacheReferences: "List of node references used in this request",
                        nodeReference: "Node reference to validate (format: {{nodeId.field}})",
                        nodeReferences: "List of node references to validate",
                        outputCacheName: "Cache name to store processed results",
                        responseMapping: "Map response fields to cache keys (format: path -> key)",
                        inputSource: "Node reference for input data (format: {{nodeId.field}})",
                        inputSources: "List of node references for data sources",
                        extractAndSave: "Extract response fields and save to cache",
                        validationRules: "Rules to validate data (REQUIRED, NOT_EMPTY, EQUALS, etc.)",
                        onValidationFail: "Action when validation fails",
                        onValidationPass: "Action when validation passes",
                        storageType: "Where to store data (database, excel, or both)",
                        databaseConfig: "Database connection settings",
                        excelConfig: "Excel file configuration",
                        dataMapping: "Map cache data to storage columns",
                        onSuccess: "Action when storage succeeds",
                        // Node checking parameters
                        nodeId: "ID of the node to check for existence",
                        outputField: "Specific output field to verify (optional)",
                        onNotExists: "Action when node or field doesn't exist",
                        expectedValue: "Value to compare against node data",
                        filterByType: "Filter nodes by their type",
                        outputFormat: "Format for the node list output",
                        saveToVariable: "Variable name to store the result",
                        // Advanced condition parameters
                        leftOperand: "Left side value for comparison (use {{nodeId.field}})",
                        rightOperand: "Right side value for comparison (node reference or literal)",
                        logicalOperator: "Combine conditions with AND/OR logic",
                        secondCondition: "Additional condition for complex logic",
                        conditions: "List of conditions to evaluate",
                        logicExpression: "Custom logic expression using condition numbers",
                        evaluationMode: "How to evaluate multiple conditions",
                        onTrueAction: "Action when condition evaluates to true",
                        onFalseAction: "Action when condition evaluates to false",
                        description: "Human-readable description of the logic"
                    },
                    vi: {
                        selector: "Bộ chọn CSS để nhắm mục tiêu phần tử HTML. Ví dụ: #myId, .myClass, button[type='submit']",
                        url: "URL trang web để điều hướng. Phải bao gồm giao thức (http:// hoặc https://)",
                        text: "Nội dung văn bản để nhập, tìm kiếm hoặc xác thực",
                        condition: "Biểu thức boolean để đánh giá. Sử dụng biến và toán tử như ==, !=, >, <",
                        timeout: "Thời gian chờ tính bằng mili giây (1000ms = 1 giây)",
                        variable: "Tên biến để lưu trữ dữ liệu trích xuất để sử dụng sau",
                        key: "Phím bàn phím để nhấn. Ví dụ: Enter, Space, Tab, Escape",
                        value: "Giá trị để nhập, chọn hoặc so sánh",
                        attribute: "Tên thuộc tính HTML như 'href', 'src', 'data-id', 'class'",
                        filename: "Tên tệp có phần mở rộng cho ảnh chụp màn hình hoặc tải lên",
                        expectedURL: "URL mong đợi để xác minh điều hướng hoạt động đúng",
                        expectedTitle: "Văn bản tiêu đề trang mong đợi để xác thực",
                        expectedValue: "Giá trị mong đợi để so sánh với giá trị phần tử thực tế",
                        expectedCount: "Số lượng phần tử mong đợi khớp với bộ chọn",
                        containsText: "Văn bản một phần nên được tìm thấy trong phần tử",
                        property: "Tên thuộc tính CSS như 'color', 'font-size', 'display'",
                        threshold: "Giá trị tối đa có thể chấp nhận (mili giây cho thời gian, MB cho bộ nhớ)",
                        operator: "Toán tử so sánh toán học (=, >, <, >=, <=)",
                        filePath: "Đường dẫn đầy đủ đến tệp tải lên, bao gồm ổ đĩa và thư mục",
                        state: "Checkbox nên được chọn (check) hay bỏ chọn (uncheck)",
                        list: "Tên biến mảng hoặc số lần lặp cho vòng lặp",
                        method: "Phương thức HTTP cho yêu cầu API (GET, POST, PUT, DELETE)",
                        endpoint: "Đường dẫn URL endpoint API (ví dụ: /api/users)",
                        responseBody: "Dữ liệu phản hồi giả lập ở định dạng JSON",
                        formSelector: "Bộ chọn CSS nhắm mục tiêu phần tử form để xác thực",
                        validationType: "Loại xác thực thực hiện trên form",
                        scope: "Phạm vi phần tử hoặc trang để kiểm tra",
                        metric: "Chỉ số hiệu suất để đo lường và xác thực",
                        devices: "Loại thiết bị để test responsive design",
                        level: "Cấp độ tuân thủ khả năng truy cập WCAG để test",
                        checks: "Các yếu tố SEO để xác thực (meta tags, headings, v.v.)",
                        action: "Điều gì cần làm khi chặn yêu cầu mạng",
                        name: "Định danh tên cookie",
                        domain: "Phạm vi domain cho cookie (tùy chọn)",
                        key: "Tên key storage để kiểm tra hoặc key dữ liệu để xác thực",
                        browsers: "Những trình duyệt nào để test khả năng tương thích",
                        condition: "Điều kiện mạng để mô phỏng cho testing",
                        downloadSpeed: "Tốc độ tải xuống tính bằng Kbps cho điều kiện mạng tùy chỉnh",
                        uploadSpeed: "Tốc độ tải lên tính bằng Kbps cho điều kiện mạng tùy chỉnh",
                        latency: "Độ trễ mạng tính bằng mili giây",
                        // Session Cache & API nodes (Vietnamese)
                        cacheName: "Tên container cache để lưu trữ dữ liệu session",
                        inputCapture: "Ánh xạ input elements thành cache keys (định dạng: #selector -> key)",
                        fromPreviousNodes: "Tham chiếu dữ liệu từ các node trước (định dạng: {{nodeId.field}} -> key)",
                        systemData: "Dữ liệu hệ thống tự động thu thập (current_url, timestamp, page_title)",
                        customData: "Dữ liệu tĩnh tùy chỉnh để bao gồm (định dạng: key -> value)",
                        bodyTemplate: "Template body HTTP request sử dụng tham chiếu {{nodeId.field}}",
                        cacheReferences: "Danh sách tham chiếu node được sử dụng trong request này",
                        nodeReference: "Tham chiếu node để validate (định dạng: {{nodeId.field}})",
                        nodeReferences: "Danh sách tham chiếu node để validate",
                        outputCacheName: "Tên cache để lưu trữ kết quả đã xử lý",
                        responseMapping: "Ánh xạ các field response thành cache keys (định dạng: path -> key)",
                        inputSource: "Tham chiếu node cho dữ liệu đầu vào (định dạng: {{nodeId.field}})",
                        inputSources: "Danh sách tham chiếu node cho nguồn dữ liệu",
                        extractAndSave: "Trích xuất các field response và lưu vào cache",
                        validationRules: "Quy tắc để validate dữ liệu (REQUIRED, NOT_EMPTY, EQUALS, v.v.)",
                        onValidationFail: "Hành động khi validation thất bại",
                        onValidationPass: "Hành động khi validation thành công",
                        storageType: "Nơi lưu trữ dữ liệu (database, excel, hoặc cả hai)",
                        databaseConfig: "Cài đặt kết nối database",
                        excelConfig: "Cấu hình file Excel",
                        dataMapping: "Ánh xạ dữ liệu cache tới các cột lưu trữ",
                        onSuccess: "Hành động khi lưu trữ thành công",
                        // Node checking parameters (Vietnamese)
                        nodeId: "ID của node cần kiểm tra sự tồn tại",
                        outputField: "Field output cụ thể để xác minh (tùy chọn)",
                        onNotExists: "Hành động khi node hoặc field không tồn tại",
                        expectedValue: "Giá trị để so sánh với dữ liệu node",
                        filterByType: "Lọc nodes theo loại của chúng",
                        outputFormat: "Định dạng cho đầu ra danh sách node",
                        saveToVariable: "Tên biến để lưu trữ kết quả",
                        // Advanced condition parameters (Vietnamese)
                        leftOperand: "Giá trị bên trái để so sánh (sử dụng {{nodeId.field}})",
                        rightOperand: "Giá trị bên phải để so sánh (tham chiếu node hoặc literal)",
                        logicalOperator: "Kết hợp điều kiện với logic AND/OR",
                        secondCondition: "Điều kiện bổ sung cho logic phức tạp",
                        conditions: "Danh sách điều kiện để đánh giá",
                        logicExpression: "Biểu thức logic tùy chỉnh sử dụng số thứ tự điều kiện",
                        evaluationMode: "Cách đánh giá nhiều điều kiện",
                        onTrueAction: "Hành động khi điều kiện đánh giá là đúng",
                        onFalseAction: "Hành động khi điều kiện đánh giá là sai",
                        description: "Mô tả có thể đọc được của logic"
                    }
                };
                
                const langCode = lang === 'vi' ? 'vi' : 'en';
                return helpTexts[langCode][paramId] || (langCode === 'vi' ? 'Hướng dẫn chưa có sẵn' : 'Help text not available');
            }

            function renderPropertiesPanel() {
                const lang = translations[currentLanguage];
                propertiesPanelContainer.innerHTML = `
                <h2 class="text-lg font-semibold mb-4 pb-2 border-b border-slate-200 dark:border-gray-700 text-slate-900 dark:text-gray-100"><i class="fas fa-sliders-h mr-2 text-slate-500 dark:text-gray-400"></i>${lang.properties}</h2>
                <div id="properties-panel" class="flex-grow overflow-y-auto"></div>`;
                const panel = document.getElementById('properties-panel');
                const node = nodes.find(n => n.id === selectedNodeId);
                if (!node) {
                    panel.innerHTML = `<p class="text-slate-500 dark:text-gray-400 text-center mt-8">${lang.selectBlockToView}</p>`;
                    return;
                }
                const actionConfig = getActionConfig();
                const config = actionConfig[node.type];
                if (!config) return;
                let formHTML = '';
                
                // Add Node ID field at the top
                const nodeIdInputId = `prop-input-${node.id}-nodeId`;
                const nodeIdLabel = currentLanguage === 'vi' ? 'ID Node' : 'Node ID';
                const nodeIdPlaceholder = currentLanguage === 'vi' ? 'Nhập ID tùy chỉnh...' : 'Enter custom ID...';
                const commonClasses = "w-full px-3 py-2 border border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-slate-800 dark:text-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500";
                
                formHTML += `<div class="mb-4 p-3 bg-slate-50 dark:bg-gray-800 rounded-md border border-slate-200 dark:border-gray-600">
                    <label for="${nodeIdInputId}" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">${nodeIdLabel}</label>
                    <input type="text" id="${nodeIdInputId}" data-param-id="nodeId" placeholder="${nodeIdPlaceholder}" value="${node.displayName || node.id}" class="${commonClasses} font-mono text-sm">
                    <p class="text-xs text-slate-500 dark:text-gray-400 mt-1">${currentLanguage === 'vi' ? 'ID này sẽ được sử dụng để tham chiếu từ các node khác' : 'This ID will be used to reference from other nodes'}</p>
                </div>`;
                
                config.params.forEach(param => {
                    const value = node.params[param.id] || '';
                    const inputId = `prop-input-${node.id}-${param.id}`;
                    formHTML += `<div class="mt-4"><label for="${inputId}" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">${param.label}</label>`;
                    const commonClasses = "w-full px-3 py-2 border border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-slate-800 dark:text-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500";

                    if (param.type === 'select') {
                        formHTML += `<div class="flex items-center space-x-2">
                        <select id="${inputId}" data-param-id="${param.id}" class="flex-grow ${commonClasses}">`;
                        param.options.forEach(opt => formHTML += `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.text}</option>`);
                        formHTML += `</select>
                        <button class="help-btn p-2 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-md" data-help="${param.id}" title="${getParamHelp(param.id, currentLanguage)}"><i class="fas fa-question-circle text-sm"></i></button>
                    </div>`;
                    } else if (param.type === 'text' || param.type === 'number') {
                        formHTML += `<div class="flex items-center space-x-2">
                        <input type="${param.type}" id="${inputId}" data-param-id="${param.id}" placeholder="${param.placeholder || ''}" value="${value}" class="flex-grow ${commonClasses}">
                        <button class="help-btn p-2 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-md" data-help="${param.id}" title="${getParamHelp(param.id, currentLanguage)}"><i class="fas fa-question-circle text-sm"></i></button>
                    </div>`;
                    } else if (param.type === 'selector') {
                        formHTML += `<div class="flex items-center space-x-2">
                        <textarea id="${inputId}" data-param-id="${param.id}" placeholder="${param.placeholder || ''}" rows="2" class="flex-grow ${commonClasses}">${value}</textarea>
                        <button class="help-btn p-2 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-md" data-help="${param.id}" title="${getParamHelp(param.id, currentLanguage)}"><i class="fas fa-question-circle text-sm"></i></button>
                    </div>`;
                    } else {
                        formHTML += `<div class="flex items-center space-x-2">
                        <textarea id="${inputId}" data-param-id="${param.id}" placeholder="${param.placeholder || ''}" rows="2" class="flex-grow ${commonClasses}">${value}</textarea>
                        <button class="help-btn p-2 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-md" data-help="${param.id}" title="${getParamHelp(param.id, currentLanguage)}"><i class="fas fa-question-circle text-sm"></i></button>
                    </div>`;
                    }
                    formHTML += `</div>`;
                });
                if (node.type !== 'start') {
                    const deleteText = currentLanguage === 'vi' ? 'Xóa Khối' : 'Delete Block';
                    formHTML += `<button id="delete-node-btn" class="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md transition-colors"><i class="fas fa-trash-alt mr-2"></i>${deleteText}</button>`;
                }
                panel.innerHTML = formHTML;

                panel.querySelectorAll('input, textarea, select').forEach(input => {
                    input.addEventListener('input', e => {
                        const paramId = e.target.dataset.paramId;
                        if (paramId === 'nodeId') {
                            // Handle node ID change
                            const newId = e.target.value.trim();
                            if (newId && newId !== node.displayName) {
                                // Check if ID is unique
                                const idExists = nodes.some(n => n.id !== node.id && (n.displayName === newId || n.id === newId));
                                if (!idExists) {
                                    node.displayName = newId;
                                    renderNodes();
                                } else {
                                    // Reset to previous value if ID already exists
                                    e.target.value = node.displayName || node.id;
                                    alert(currentLanguage === 'vi' ? 'ID đã tồn tại!' : 'ID already exists!');
                                }
                            }
                        } else {
                            node.params[paramId] = e.target.value;
                            renderNodes();
                        }
                    });
                });

                // Help tooltips - no need for additional event listeners as title attribute handles hover

                const deleteBtn = panel.querySelector('#delete-node-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (node.type === 'start') return;
                        nodes = nodes.filter(n => n.id !== selectedNodeId);
                        connections = connections.filter(c => c.fromNode !== selectedNodeId && c.toNode !== selectedNodeId);
                        selectedNodeId = null;
                        renderAll();
                    });
                }
            }

            function renderTestPanel() {
                propertiesPanelContainer.innerHTML = `
                <h2 class="text-lg font-semibold mb-4 pb-2 border-b border-slate-200 dark:border-gray-700 text-slate-900 dark:text-gray-100"><i class="fas fa-tasks mr-2 text-green-500"></i>Kết quả Test</h2>
                <pre id="panel-log-content" class="flex-grow bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-gray-200 text-sm p-2 rounded-md font-mono whitespace-pre-wrap overflow-y-auto mb-4"></pre>
                <div id="test-controls" class="flex-shrink-0 flex space-x-2">
                     <button id="stop-test-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md transition-colors"><i class="fas fa-stop mr-2"></i>Dừng</button>
                     <button id="close-test-panel-btn" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold px-4 py-2 rounded-md transition-colors hidden"><i class="fas fa-times mr-2"></i>Kết thúc</button>
                </div>`;
                document.getElementById('stop-test-btn').addEventListener('click', () => { isTestStopped = true; });
                document.getElementById('close-test-panel-btn').addEventListener('click', () => {
                    isTesting = false;
                    renderPropertiesPanel();
                });
            }

            async function startTest() {
                if (isTesting) return;
                isTesting = true;
                isTestStopped = false;
                testButton.disabled = true;
                testButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Testing...`;
                renderTestPanel();
                try {
                    await runTestSimulation();
                } catch (e) {
                    console.error("Test simulation failed:", e);
                    const logEl = document.getElementById('panel-log-content');
                    if (logEl) logEl.textContent += '\n\nLỗi nghiêm trọng xảy ra khi chạy mô phỏng.';
                } finally {
                    testButton.disabled = false;
                    testButton.innerHTML = `<i class="fas fa-play mr-2"></i>Test`;
                    const stopBtn = document.getElementById('stop-test-btn');
                    const closeBtn = document.getElementById('close-test-panel-btn');
                    if (stopBtn) stopBtn.classList.add('hidden');
                    if (closeBtn) closeBtn.classList.remove('hidden');
                }
            }

            const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

            async function runTestSimulation() {
                const logEl = document.getElementById('panel-log-content');
                let log = [];
                const startNode = nodes.find(n => n.type === 'start');
                if (!startNode) {
                    logEl.textContent = "Lỗi: Không tìm thấy khối 'Bắt đầu'.";
                    return;
                }
                logEl.textContent = "Bắt đầu mô phỏng...\n";
                let currentNode = startNode;
                let visitedCount = {};
                while (currentNode && !isTestStopped) {
                    visitedCount[currentNode.id] = (visitedCount[currentNode.id] || 0) + 1;
                    if (visitedCount[currentNode.id] > 50) {
                        log.push(`\n⚠️ Dừng lại do vòng lặp vô hạn có thể xảy ra tại khối ${currentNode.id}`);
                        break;
                    }
                    const nodeEl = document.getElementById(currentNode.id);
                    if (nodeEl) nodeEl.classList.add('ring-2', 'ring-green-500');
                    const actionConfig = getActionConfig();
                    const config = actionConfig[currentNode.type];
                    log.push(`\n▶️ [${config.name}]`);
                    Object.entries(currentNode.params).forEach(([key, val]) => {
                        if (val) log.push(`   - ${key}: ${val}`);
                    });
                    logEl.textContent = log.join('\n');
                    logEl.scrollTop = logEl.scrollHeight;
                    await sleep(700);
                    let nextNodeId = null;
                    if (currentNode.type === 'if') {
                        const thenConn = connections.find(c => c.fromNode === currentNode.id && c.fromPort === 'then');
                        if (thenConn) {
                            nextNodeId = thenConn.toNode;
                            log.push(`   -> Rẽ nhánh THEN (mô phỏng)`);
                        }
                    } else {
                        const connection = connections.find(c => c.fromNode === currentNode.id);
                        if (connection) nextNodeId = connection.toNode;
                    }
                    if (nodeEl) nodeEl.classList.remove('ring-2', 'ring-green-500');
                    if (currentNode.type === 'stop') {
                        log.push('⏹️ Luồng đã dừng tại khối Stop.');
                        nextNodeId = null;
                    }
                    currentNode = nodes.find(n => n.id === nextNodeId);
                }
                if (isTestStopped) {
                    log.push('\n\n⏹️ Người dùng đã dừng mô phỏng.');
                } else if (!currentNode && !log.some(l => l.includes('⏹️'))) {
                    log.push('\n\n✅ Mô phỏng hoàn tất.');
                }
                logEl.textContent = log.join('\n');
                logEl.scrollTop = logEl.scrollHeight;
            }

            function applyTransform() {
                transformContainer.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
            }

            document.querySelectorAll('.action-card').forEach(card => card.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.currentTarget.dataset.actionType)));
            canvasContainer.addEventListener('dragover', e => e.preventDefault());
            canvasContainer.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('text/plain');
                const rect = canvasContainer.getBoundingClientRect();
                const x = (e.clientX - rect.left - panX) / scale;
                const y = (e.clientY - rect.top - panY) / scale;
                const newNode = createNode(type, x - 110, y - 40);
                nodes.push(newNode);
                selectedNodeId = newNode.id;
                renderAll();
            });
            canvasContainer.addEventListener('wheel', e => {
                e.preventDefault();
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const oldScale = scale;


                if (e.ctrlKey || e.metaKey) {
                    const zoom = e.deltaY > 0 ? 0.9 : 1.1;
                    scale = Math.max(0.2, Math.min(3, scale * zoom));

                    panX = mouseX - (mouseX - panX) * (scale / oldScale);
                    panY = mouseY - (mouseY - panY) * (scale / oldScale);
                } else {

                    panX += e.deltaX * -1;
                    panY += e.deltaY * -1;
                }

                applyTransform();
            });
            canvasContainer.addEventListener('mousedown', e => {
                if (isSpacePressed || e.button === 1) {
                    isPanning = true;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                    canvasContainer.classList.add('panning');
                }
            });
            window.addEventListener('keydown', e => {
                if (e.code === 'Space' && !isSpacePressed) {
                    e.preventDefault();
                    isSpacePressed = true;
                    canvasContainer.classList.add('pannable');
                }
            });
            window.addEventListener('keyup', e => {
                if (e.code === 'Space') {
                    isSpacePressed = false;
                    isPanning = false;
                    canvasContainer.classList.remove('pannable', 'panning');
                }
            });
            clearButton.addEventListener('click', () => {
                const confirmText = currentLanguage === 'vi' ? 'Bạn có chắc muốn xóa toàn bộ luồng công việc?' : 'Are you sure you want to clear the entire workflow?';
                if (confirm(confirmText)) init();
            });
            document.getElementById('guideline-button').addEventListener('click', () => {
                window.open('./guideline.html', '_blank');
            });
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            canvasContainer.addEventListener('click', e => {
                if (isTesting) return;
                if (e.target === canvasContainer || e.target === transformContainer) {
                    selectedNodeId = null;

                    document.querySelectorAll('.workflow-node').forEach(node => {
                        node.classList.remove('show-ports');
                    });
                    renderAll();
                }
            });
            exportButton.addEventListener('click', () => {
                const dataStr = JSON.stringify({ nodes, connections, panX, panY, scale }, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = 'workflow.json';
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });
            importButton.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data && data.nodes && data.connections) init(data);
                        else {
                            const errorText = currentLanguage === 'vi' ? 'Tệp JSON không hợp lệ.' : 'Invalid JSON file.';
                            alert(errorText);
                        }
                    } catch (error) {
                        const errorText = currentLanguage === 'vi' ? 'Lỗi khi đọc tệp: ' : 'Error reading file: ';
                        alert(errorText + error.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            testButton.addEventListener('click', startTest);



            function init(initialData = null) {
                const data = initialData || { nodes: [createNode('start', 200, 150)], connections: [], panX: 0, panY: 0, scale: 1 };
                panX = data.panX || 0;
                panY = data.panY || 0;
                scale = data.scale || 1;
                nodes = data.nodes;
                connections = data.connections;
                
                // Reset node counters and ensure all nodes have displayName
                resetNodeCounters();
                nodes.forEach(node => {
                    if (!node.displayName) {
                        node.displayName = node.id;
                    }
                    // Update counters based on existing nodes
                    const typeMap = {
                        'start': 'start',
                        'stop': 'stop',
                        'goto': 'goToUrl',
                        'fill': 'inputText',
                        'click': 'clickElement',
                        'getText': 'getText',
                        'getAttribute': 'getAttribute',
                        'waitElement': 'waitElement',
                        'sessionCache': 'sessionCache',
                        'customApiRequest': 'apiRequest',
                        'responseProcessor': 'processResponse',
                        'storageSettings': 'storageSettings',
                        'checkNodeExists': 'checkNodeExists',
                        'checkNodeValue': 'checkNodeValue',
                        'getNodeList': 'getNodeList',
                        'validateNodeData': 'validateNodeData',
                        'if': 'condition',
                        'advancedCondition': 'advancedCondition',
                        'forEach': 'loop',
                        'comment': 'comment'
                    };
                    
                    const baseName = typeMap[node.type] || node.type;
                    const match = node.displayName.match(new RegExp(`^${baseName}_(\\d+)$`));
                    if (match) {
                        const counter = parseInt(match[1]);
                        if (!nodeCounters[node.type] || nodeCounters[node.type] < counter) {
                            nodeCounters[node.type] = counter;
                        }
                    }
                });
                
                selectedNodeId = data.nodes[0]?.id || null;
                renderAll();
            }

            init();

            document.querySelectorAll('details').forEach(detail => {
                const marker = detail.querySelector('.details-marker');
                detail.addEventListener('toggle', () => marker.classList.toggle('rotate-90', detail.open));
                if (detail.open) marker.classList.add('rotate-90');
            });
        });
    </script>
</body>

</html>